
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>digital education india</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --bs-primary-rgb: 71, 85, 229; /* Indigo */
            --bs-secondary-rgb: 108, 117, 125;
            --bs-success-rgb: 22, 163, 74;
            --bs-danger-rgb: 220, 38, 38;
            --bs-warning-rgb: 245, 158, 11;
            --bs-info-rgb: 14, 165, 233;
            --bs-light-rgb: 248, 249, 250;
            --bs-dark-rgb: 30, 41, 59; /* Slate 800 */
            --bs-font-sans-serif: 'Inter', sans-serif;
            --bs-body-bg: #f1f5f9; /* Slate 100 */
            --sidebar-bg: #1e293b; /* Slate 800 */
            --sidebar-link-color: #cbd5e1; /* Slate 300 */
            --sidebar-link-hover-bg: #334155; /* Slate 700 */
            --sidebar-link-active-bg: rgb(var(--bs-primary-rgb));
            --navbar-bg: #ffffff;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --bs-primary: rgb(var(--bs-primary-rgb));
            --bs-secondary: rgb(var(--bs-secondary-rgb));
            --bs-success: rgb(var(--bs-success-rgb));
            --bs-danger: rgb(var(--bs-danger-rgb));
        }

        body {
            background-color: var(--bs-body-bg);
            font-family: var(--bs-font-sans-serif);
        }

        .view { display: none; }
        .view.active { display: block; }

        /* Navbar */
        .navbar {
            background-color: var(--navbar-bg);
            box-shadow: var(--card-shadow);
            padding: 0.8rem 1rem;
        }
        .navbar-brand { font-weight: 700; color: var(--bs-primary) !important; font-size: 1.5rem; }
        .navbar-brand i { margin-right: 8px; }
        .sidebar-toggler { color: var(--bs-primary); font-size: 1.5rem; }
        .btn-logout { color: var(--bs-danger); border-color: var(--bs-danger); }
        .btn-logout:hover { background-color: var(--bs-danger); color: #fff; }

        /* Login/Register Card */
        #loginView .card { border: none; border-radius: 1rem; overflow: hidden; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        #loginView .card-header { background: linear-gradient(135deg, var(--bs-primary) 0%, #a855f7 100%); padding: 2rem; border-bottom: none; }
        #loginView .card-header i { font-size: 2rem; }
        #loginView .nav-pills .nav-link { color: var(--bs-dark); font-weight: 600; border-radius: 0.5rem; transition: all 0.3s ease; margin: 0 5px; padding: 0.75rem 1rem; }
        #loginView .nav-pills .nav-link.active { background-color: var(--bs-primary); color: white; box-shadow: 0 4px 14px 0 rgba(var(--bs-primary-rgb), 0.39); }
        #loginView .nav-pills .nav-link i { margin-right: 8px; }
        #loginView .form-control { border-radius: 0.5rem; padding: 1rem; font-size: 1rem; background-color: var(--bs-light); border: 1px solid #e2e8f0; }
        #loginView .form-floating>label { padding: 1rem; color: var(--bs-secondary); }
        #loginView .btn { border-radius: 0.5rem; padding: 0.8rem 1rem; font-weight: 600; }

        /* Dashboard */
        .dashboard-sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-link-color); position: fixed; top: 0; bottom: 0; left: 0; z-index: 1030; padding: 65px 0 0; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: transform 0.3s ease-in-out; width: 260px; }
        @media (max-width: 767.98px) { .dashboard-sidebar { transform: translateX(-100%); width: 280px; } .dashboard-sidebar.show { transform: translateX(0); } }
        .sidebar-sticky { height: calc(100vh - 65px); overflow-y: auto; padding: 1rem 0; }
        .dashboard-sidebar .nav-link { color: var(--sidebar-link-color); padding: 0.8rem 1.5rem; margin: 0.1rem 0.8rem; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease; font-weight: 500; display: flex; align-items: center; font-size: 0.95rem; }
        .dashboard-sidebar .nav-link:hover { background-color: var(--sidebar-link-hover-bg); color: #fff; transform: translateX(4px); }
        .dashboard-sidebar .nav-link.active { background-color: var(--sidebar-link-active-bg); color: #fff; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(var(--bs-primary-rgb), 0.3), 0 2px 4px -2px rgba(var(--bs-primary-rgb), 0.3); }
        .dashboard-sidebar .nav-link i { margin-right: 15px; width: 20px; text-align: center; font-size: 1.1em; }
        .dashboard-sidebar .nav-title { padding: 0.5rem 1.5rem; font-size: 0.75rem; color: #94a3b8; /* Slate 400 */ text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1rem; }

        /* Main Content Area */
        #principalDashboardView main, #teacherDashboardView main { padding-top: 65px; margin-left: 260px; transition: margin-left 0.3s ease-in-out; }
        @media (max-width: 767.98px) { #principalDashboardView main, #teacherDashboardView main { margin-left: 0; } }
        .dashboard-pane { display: none; }
        .dashboard-pane.active { display: block; animation: animate__fadeIn 0.4s ease-out; }
        .dashboard-content { background-color: transparent; border-radius: 0; margin: 0; padding: 1.5rem; box-shadow: none; }
        .dashboard-content .card { background-color: var(--card-bg); box-shadow: var(--card-shadow); border-radius: 0.75rem; }
        .dashboard-content .card-header { background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); color: var(--bs-dark); border-bottom: 1px solid #e5e7eb; border-radius: 0.75rem 0.75rem 0 0; }
        .dashboard-content .card-header i { color: var(--bs-primary); }

        /* Stat Cards (Dashboard Overview) */
        #principal-dashboard-overview .stat-card {
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Align icon and text */
            padding: 1.5rem;
            min-height: 120px;
            color: #fff;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            position: relative; /* For pseudo-elements or overlays */
        }

        #principal-dashboard-overview .stat-card::before { /* Optional subtle overlay */
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 50%);
            opacity: 0.7;
            pointer-events: none;
        }

        #principal-dashboard-overview .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        #principal-dashboard-overview .stat-card .stat-icon {
            font-size: 2.8rem; /* Slightly larger icon */
            opacity: 0.6; /* Slightly less opaque */
            width: 60px; /* Fixed width */
            height: 60px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            background-color: rgba(255, 255, 255, 0.15); /* Subtle background for icon */
            border-radius: 50%; /* Circular background */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        #principal-dashboard-overview .stat-card .stat-info {
            text-align: right; /* Align text to the right */
            flex-grow: 1; /* Allow text to take remaining space */
        }
        #principal-dashboard-overview .stat-card .stat-info h3 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
            line-height: 1.2;
        }
        #principal-dashboard-overview .stat-card .stat-info p {
            font-size: 0.95rem; /* Slightly larger text */
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 0;
            text-transform: uppercase; /* Uppercase label */
            letter-spacing: 0.5px; /* Slight letter spacing */
        }

        /* Stat Card Specific Colors */
        .stat-card-students { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); } /* Indigo to Violet */
        .stat-card-staff { background: linear-gradient(135deg, #10b981 0%, #059669 100%); } /* Emerald */
        .stat-card-classes { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); } /* Orange */
        .stat-card-income { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); } /* Green */
        .stat-card-expenses { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); } /* Red */
        .stat-card-salary { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); } /* Purple */
        .stat-card-balance { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); } /* Blue */


        /* Buttons */
        .btn { border-radius: 0.5rem; padding: 0.6rem 1.2rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); border: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn:active { transform: translateY(0); } .btn i { margin-right: 6px; }
        .btn-copy { padding: 0.2rem 0.5rem; font-size: 0.8em; margin-left: 8px; }

        /* Forms */
        .form-control, .form-select { border-radius: 0.5rem; padding: 0.75rem 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; background-color: #fff; border: 1px solid #d1d5db; }
        .form-control:focus, .form-select:focus { border-color: var(--bs-primary); box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.15); }
        .form-label { font-weight: 500; margin-bottom: 0.5rem; color: #4b5563; }

        /* Tables */
        .table>:not(caption)>*>* { padding: 1rem; background-color: var(--bs-table-bg, transparent); border-bottom-width: 1px; box-shadow: inset 0 0 0 9999px var(--bs-table-accent-bg, transparent); }
        .table thead th { background-color: #f9fafb; /* Gray 50 */ font-weight: 600; color: #374151; /* Gray 700 */ text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; }
        .table tbody tr:hover { background-color: #f3f4f6; /* Gray 100 */ }
        .table td { vertical-align: middle; }
        .table img.rounded-circle { border: 2px solid #e5e7eb; }

        /* Loading Indicator */
        #loadingIndicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        #loadingIndicator .spinner-border { width: 3.5rem; height: 3.5rem; color: var(--bs-primary); border-width: .3em; }
        #loadingIndicator p { margin-top: 1.2rem; font-weight: 500; color: var(--bs-dark); font-size: 1.1rem; }

        /* Alert Area */
        #alertArea { position: fixed; top: 75px; right: 1rem; z-index: 1100; width: auto; max-width: 450px; }
        .alert { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); border-radius: 0.75rem; border: none; }

        /* Chart Container */
        .chart-container { position: relative; width: 100%; height: 350px; margin-bottom: 2rem; background-color: #fff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--card-shadow); }
        .chart-container canvas { max-width: 100%; max-height: 100%; }

        /* Modal Styling */
        .modal-content { border-radius: 0.75rem; border: none; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .modal-header { background: linear-gradient(135deg, var(--bs-primary) 0%, #a855f7 100%); color: white; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; border-bottom: none; padding: 1.2rem 1.5rem; }
        .modal-header .btn-close { filter: brightness(0) invert(1); opacity: 0.8; }
        .modal-title { font-weight: 600; } .modal-body { padding: 1.5rem 2rem; }
        .modal-footer { border-top: 1px solid #e5e7eb; padding: 1rem 2rem; }

        /* Animations */
        .animate__animated { --animate-duration: 0.6s; }

        /* Button Loading State */
        .btn.button-loading { position: relative; color: transparent !important; pointer-events: none; }
        .btn.button-loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 1.2em; height: 1.2em; margin-top: -0.6em; margin-left: -0.6em; border: 2px solid rgba(255, 255, 255, 0.8); border-right-color: transparent; border-radius: 50%; animation: button-spin 0.6s linear infinite; color: white; }
        @keyframes button-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Profile Modal Specific Styles */
        .profile-modal-img { width: 120px; height: 120px; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .profile-modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding-bottom: 3rem; margin-bottom: -2rem; border-radius: 0.75rem 0.75rem 0 0; }
        .profile-modal-body { padding-top: 3rem; } /* Overlap image onto header */
        .profile-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .profile-section:last-child { border-bottom: none; margin-bottom: 0; }
        .profile-section h5 { font-weight: 600; color: var(--bs-primary); margin-bottom: 1rem; }
        .profile-info p { margin-bottom: 0.6rem; font-size: 0.95rem; }
        .profile-info p strong { color: #4b5563; /* Gray 600 */ min-width: 120px; display: inline-block; }
        .profile-info i.fa-fw { color: var(--bs-secondary); margin-right: 8px; }

        /* Attendance / Fee Records in Profile */
        .profile-records-list { max-height: 200px; overflow-y: auto; font-size: 0.9rem; }

    </style>
</head>
<body>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display: none;">
        <div class="spinner-border" role="status"> <span class="visually-hidden">Loading...</span> </div>
        <p class="mt-2">Processing...</p>
    </div>

    <!-- Alert Area -->
    <div id="alertArea"></div>

    <!-- ==================== Login/Registration View ==================== -->
    <div id="loginView" class="view active animate__animated animate__fadeIn">
        <div class="min-vh-100 d-flex justify-content-center align-items-center p-3" style="background: var(--bs-body-bg);">
            <div class="col-md-9 col-lg-7 col-xl-6">
                <div class="card animate__animated animate__zoomIn">
                    <div class="card-header text-center text-white fs-4"> <i class="fas fa-school-flag me-2"></i> Digital education india</div>
                    <div class="card-body p-4 p-md-5">
                        <ul class="nav nav-pills mb-4 nav-fill" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation"> <button class="nav-link active" id="pills-principal-login-tab" data-bs-toggle="pill" data-bs-target="#pills-principal-login" type="button"><i class="fas fa-user-tie"></i> Principal</button> </li>
                            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-teacher-login-tab" data-bs-toggle="pill" data-bs-target="#pills-teacher-login" type="button"><i class="fas fa-chalkboard-teacher"></i> Teacher</button> </li>
                            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button"><i class="fas fa-user-plus"></i> Register</button> </li>
                        </ul>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-principal-login" role="tabpanel"> <form id="principalLoginForm"> <div class="form-floating mb-3"> <input type="tel" class="form-control" id="principalMobile" placeholder="Mobile Number" required> <label for="principalMobile"><i class="fas fa-mobile-alt me-2"></i>Mobile Number</label> </div> <div class="form-floating mb-3"> <input type="password" class="form-control" id="principalPassword" placeholder="Password" required> <label for="principalPassword"><i class="fas fa-lock me-2"></i>Password</label> </div> <button type="submit" class="btn btn-primary w-100 btn-lg"><i class="fas fa-sign-in-alt me-1"></i> Login as Principal</button> </form> </div>
                            <div class="tab-pane fade" id="pills-teacher-login" role="tabpanel"> <form id="teacherLoginForm"> <div class="form-floating mb-3"> <input type="email" class="form-control" id="teacherSchoolGmail" placeholder="Principal's Gmail" required> <label for="teacherSchoolGmail"><i class="fas fa-envelope me-2"></i>School Principal's Gmail</label> </div> <div class="form-floating mb-3"> <input type="text" class="form-control" id="teacherStaffId" placeholder="Staff ID" required> <label for="teacherStaffId"><i class="fas fa-id-badge me-2"></i>Staff ID</label> </div> <div class="form-floating mb-3"> <input type="password" class="form-control" id="teacherPassword" placeholder="Password" required> <label for="teacherPassword"><i class="fas fa-lock me-2"></i>Password</label> </div> <button type="submit" class="btn btn-success w-100 btn-lg"><i class="fas fa-sign-in-alt me-1"></i> Login as Teacher</button> </form> </div>
                            <div class="tab-pane fade" id="pills-register" role="tabpanel"> <form id="registrationForm"> <div class="row g-3"> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="schoolName" placeholder="School Name" required> <label for="schoolName">School Name*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="principalName" placeholder="Principal Name" required> <label for="principalName">Principal Name*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="tel" class="form-control" id="principalMobileReg" placeholder="Principal Mobile" required> <label for="principalMobileReg">Principal Mobile*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="email" class="form-control" id="principalGmail" placeholder="Principal Gmail" required> <label for="principalGmail">Principal Gmail*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="password" class="form-control" id="passwordReg" placeholder="Password" required> <label for="passwordReg">Password*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="password" class="form-control" id="confirmPasswordReg" placeholder="Confirm Password" required> <label for="confirmPasswordReg">Confirm Password*</label> </div> </div> <div class="col-12"> <div class="form-floating"> <textarea class="form-control" id="schoolAddress" placeholder="School Address" rows="2" required style="height: 80px;"></textarea> <label for="schoolAddress">School Address*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="url" class="form-control" id="website" placeholder="School Website"> <label for="website">School Website</label> </div> </div> <div class="col-md-6"> <label for="schoolImage" class="form-label small mb-1 ms-1">School Logo/Image</label> <input type="file" class="form-control" id="schoolImage" accept="image/*"> </div> </div> <div id="passwordMismatchError" class="text-danger mt-2 text-center" style="display: none;">Passwords do not match!</div> <button type="submit" class="btn btn-info w-100 text-white mt-3 btn-lg"><i class="fas fa-user-plus me-1"></i> Register School</button> </form> </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== Principal Dashboard View ==================== -->
    <div id="principalDashboardView" class="view">
        <nav class="navbar navbar-expand-lg navbar-light fixed-top"> <div class="container-fluid"> <button class="btn btn-link sidebar-toggler me-3 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#principalSidebarOffcanvas"><i class="fas fa-bars"></i></button> <a class="navbar-brand" href="#"><i class="fas fa-shield-alt"></i> <span id="principalSchoolName">School</span></a> <div class="ms-auto"> <button id="logoutButton" class="btn btn-outline-danger btn-logout"><i class="fas fa-sign-out-alt me-1"></i> Logout</button> </div> </div> </nav>
        <div class="offcanvas offcanvas-start dashboard-sidebar" tabindex="-1" id="principalSidebarOffcanvas" aria-labelledby="principalSidebarLabel"> <div class="offcanvas-header border-bottom border-secondary"> <h5 class="offcanvas-title text-white" id="principalSidebarLabel"><i class="fas fa-list-ul me-2"></i> Menu</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body p-0"> <nav class="nav flex-column sidebar-sticky"> <div class="nav-title">Main</div> <a class="nav-link active" href="#principal-dashboard-overview" data-view="principal-dashboard-overview" data-bs-dismiss="offcanvas"> <i class="fas fa-tachometer-alt fa-fw"></i> Overview </a> <div class="nav-title">Management</div> <a class="nav-link" href="#principal-manage-students" data-view="principal-manage-students" data-bs-dismiss="offcanvas"> <i class="fas fa-user-graduate fa-fw"></i> Students </a> <a class="nav-link" href="#principal-manage-staff" data-view="principal-manage-staff" data-bs-dismiss="offcanvas"> <i class="fas fa-user-tie fa-fw"></i> Staff </a> <a class="nav-link" href="#principal-manage-classes" data-view="principal-manage-classes" data-bs-dismiss="offcanvas"> <i class="fas fa-school fa-fw"></i> Classes & Subjects </a> <a class="nav-link" href="#principal-manage-fees" data-view="principal-manage-fees" data-bs-dismiss="offcanvas"> <i class="fas fa-money-bill-wave fa-fw"></i> Fees </a> <a class="nav-link" href="#principal-manage-salary" data-view="principal-manage-salary" data-bs-dismiss="offcanvas"> <i class="fas fa-hand-holding-usd fa-fw"></i> Salary </a> <a class="nav-link" href="#principal-manage-expenses" data-view="principal-manage-expenses" data-bs-dismiss="offcanvas"> <i class="fas fa-receipt fa-fw"></i> Expenses </a> <div class="nav-title">Records</div> <a class="nav-link" href="#principal-attendance" data-view="principal-attendance" data-bs-dismiss="offcanvas"> <i class="fas fa-calendar-check fa-fw"></i> Attendance </a> <a class="nav-link" href="#principal-results" data-view="principal-results" data-bs-dismiss="offcanvas"> <i class="fas fa-poll fa-fw"></i> Results </a> </nav> </div> </div>
        <div class="container-fluid">
            <div class="row">
                <nav id="principalSidebar" class="col-md-3 col-lg-2 d-none d-md-block dashboard-sidebar"> <div class="position-sticky sidebar-sticky"> <ul class="nav flex-column"> <li class="nav-title">Main</li> <li class="nav-item"> <a class="nav-link active" href="#principal-dashboard-overview" data-view="principal-dashboard-overview"> <i class="fas fa-tachometer-alt fa-fw"></i> Overview </a> </li> <li class="nav-title">Management</li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-students" data-view="principal-manage-students"> <i class="fas fa-user-graduate fa-fw"></i> Students </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-staff" data-view="principal-manage-staff"> <i class="fas fa-user-tie fa-fw"></i> Staff </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-classes" data-view="principal-manage-classes"> <i class="fas fa-school fa-fw"></i> Classes & Subjects </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-fees" data-view="principal-manage-fees"> <i class="fas fa-money-bill-wave fa-fw"></i> Fees </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-salary" data-view="principal-manage-salary"> <i class="fas fa-hand-holding-usd fa-fw"></i> Salary </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-manage-expenses" data-view="principal-manage-expenses"> <i class="fas fa-receipt fa-fw"></i> Expenses </a> </li> <li class="nav-title">Records</li> <li class="nav-item"> <a class="nav-link" href="#principal-attendance" data-view="principal-attendance"> <i class="fas fa-calendar-check fa-fw"></i> Attendance </a> </li> <li class="nav-item"> <a class="nav-link" href="#principal-results" data-view="principal-results"> <i class="fas fa-poll fa-fw"></i> Results </a> </li> </ul> </div> </nav>

                 <!-- ==================== Principal Dashboard Overview (MODIFIED) ==================== -->
                 <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                    <div class="dashboard-tab-content pt-3 pb-2 mb-3">
                        <div id="principal-dashboard-overview" class="dashboard-pane active">
                            <div class="dashboard-content border-0 p-0">
                                <h2 class="h4 mb-4 animate__animated animate__slideInDown"><i class="fas fa-chart-pie text-primary me-2"></i> Dashboard Overview</h2>
                                <div class="row g-4">
                                    <!-- Total Students -->
                                    <div class="col-md-6 col-xl-4 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                                        <div class="stat-card stat-card-students">
                                            <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalStudents">0</h3>
                                                <p>Students</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Active Staff -->
                                    <div class="col-md-6 col-xl-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                                        <div class="stat-card stat-card-staff">
                                            <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalStaff">0</h3>
                                                <p>Active Staff</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Total Classes -->
                                    <div class="col-md-12 col-xl-4 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                                        <div class="stat-card stat-card-classes">
                                            <div class="stat-icon"><i class="fas fa-school"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalClasses">0</h3>
                                                <p>Total Classes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Total Income -->
                                    <div class="col-sm-6 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                                        <div class="stat-card stat-card-income">
                                            <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalIncome">Rs 0.00</h3>
                                                <p>Income</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Total Expenses -->
                                    <div class="col-sm-6 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
                                        <div class="stat-card stat-card-expenses">
                                            <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalExpenses">Rs 0.00</h3>
                                                <p>Expenses</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Salary Paid -->
                                    <div class="col-sm-6 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
                                        <div class="stat-card stat-card-salary">
                                            <div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statTotalSalaryPaid">Rs 0.00</h3>
                                                <p>Salary Paid</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Net Balance -->
                                    <div class="col-sm-6 col-lg-3 animate__animated animate__fadeInUp" style="animation-delay: 0.7s;">
                                        <div class="stat-card stat-card-balance">
                                            <div class="stat-icon"><i class="fas fa-balance-scale-right"></i></div>
                                            <div class="stat-info">
                                                <h3 id="statNetBalance">Rs 0.00</h3>
                                                <p>Net Balance</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Charts Row -->
                                <div class="row g-4 mt-4">
                                    <div class="col-lg-6 animate__animated animate__fadeInLeft" style="animation-delay: 0.8s;">
                                        <div class="chart-container">
                                            <h5 class="text-center mb-3 text-secondary fw-normal">Attendance Trend (Demo)</h5>
                                            <canvas id="principalAttendanceChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 animate__animated animate__fadeInRight" style="animation-delay: 0.9s;">
                                        <div class="chart-container">
                                            <h5 class="text-center mb-3 text-secondary fw-normal">Financial Flow (Demo)</h5>
                                            <canvas id="principalFinancialChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- ==================== End Principal Dashboard Overview (MODIFIED) ==================== -->

                         <div id="principal-manage-students" class="dashboard-pane"> <div class="dashboard-content"> <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4"> <h2 class="h4"><i class="fas fa-user-graduate"></i>Manage Students</h2> <div class="btn-toolbar mb-2 mb-md-0"> <div class="input-group input-group-sm me-2"> <label class="input-group-text" for="studentClassFilter"><i class="fas fa-filter"></i></label> <select class="form-select" id="studentClassFilter"> <option value="">All Classes</option> </select> </div> <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal"><i class="fas fa-user-plus"></i> Add Student</button> </div> </div> <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th>ID</th> <th>Roll</th> <th>Name</th> <th>Class</th> <th>Mobile</th> <th>Photo</th> <th>Actions</th> </tr> </thead> <tbody id="principalStudentList"></tbody> </table> </div> </div> </div>
                         <div id="principal-manage-staff" class="dashboard-pane"> <div class="dashboard-content"> <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4"> <h2 class="h4"><i class="fas fa-user-tie"></i>Manage Staff</h2> <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStaffModal"><i class="fas fa-user-plus"></i> Add Staff</button> </div> <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th>Staff ID</th> <th>Name</th> <th>Mobile</th> <th>Joined</th> <th>Status</th> <th>Photo</th> <th>Actions</th> </tr> </thead> <tbody id="principalStaffList"></tbody> </table> </div> </div> </div>
                         <div id="principal-manage-classes" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-school"></i>Manage Classes & Subjects</h2> <div class="alert alert-info d-flex align-items-center" role="alert"> <i class="fas fa-info-circle me-3 fs-4"></i> <div> Use the external <a href="school_mgmt_tool.html" target="_blank" class="alert-link fw-bold">Management Tool</a> to add/edit classes, subjects, and assignments.</div> </div> <div class="row g-4"> <div class="col-md-6"> <div class="card h-100"> <div class="card-header"><i class="fas fa-chalkboard"></i>Classes</div> <div class="card-body p-2"> <ul id="principalClassList" class="list-group list-group-flush"><li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li></ul> </div> </div> </div> <div class="col-md-6"> <div class="card h-100"> <div class="card-header"><i class="fas fa-book"></i>Subjects</div> <div class="card-body p-2"> <ul id="principalSubjectList" class="list-group list-group-flush"><li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li></ul> </div> </div> </div> </div> <div class="card mt-4"> <div class="card-header"><i class="fas fa-user-tag"></i>Teacher Assignments</div> <div class="card-body"> <div id="principalTeacherAssignmentList" class="table-responsive"><p class="text-center p-3"><div class="spinner-border spinner-border-sm"></div> Loading...</p></div> </div> </div> </div> </div>
                         <div id="principal-manage-fees" class="dashboard-pane"> <div class="dashboard-content"> <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4"> <h2 class="h4"><i class="fas fa-money-bill-wave"></i>Manage Fees</h2> <div> <button class="btn btn-info text-white me-2" data-bs-toggle="modal" data-bs-target="#addFeeTypeModal"><i class="fas fa-tags"></i> Add Fee Type</button> <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStudentFeeModal"><i class="fas fa-plus"></i> Add Student Fee</button> </div> </div> <div class="row g-4"> <div class="col-lg-5"> <div class="card mb-4"> <div class="card-header"><i class="fas fa-tags"></i>Fee Types</div> <div class="card-body p-2"> <ul id="principalFeeTypeList" class="list-group list-group-flush"><li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li></ul> </div> </div> </div> <div class="col-lg-7"> <h3 class="h5 text-secondary mb-3">Student Fee Records</h3> <div class="table-responsive"> <table class="table table-sm table-hover align-middle"> <thead> <tr> <th>Student</th> <th>Type</th> <th>Amt</th> <th>Due</th> <th>Status</th> <th>Actions</th> </tr> </thead> <tbody id="principalStudentFeeList"></tbody> </table> </div> </div> </div> </div> </div>
                         <div id="principal-manage-salary" class="dashboard-pane"> <div class="dashboard-content"> <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4"> <h2 class="h4"><i class="fas fa-hand-holding-usd"></i>Manage Staff Salary</h2> <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSalaryPaymentModal"><i class="fas fa-plus"></i> Record Payment</button> </div> <div class="row g-4"> <div class="col-lg-7"> <h3 class="h5 text-secondary mb-3">Salary Payment History</h3> <div class="table-responsive"> <table class="table table-sm table-hover align-middle"> <thead> <tr> <th>Staff</th> <th>Date</th> <th>Amt</th> <th>Month</th> <th>Notes</th> </tr> </thead> <tbody id="principalSalaryPaymentList"></tbody> </table> </div> </div> <div class="col-lg-5"> <h3 class="h5 text-secondary mb-3">Staff Salary Summary</h3> <div class="table-responsive"> <table class="table table-sm table-bordered"> <thead> <tr> <th>Staff</th> <th>Salary</th> <th>Paid</th> <th>Dues</th> </tr> </thead> <tbody id="principalStaffSalarySummary"></tbody> </table> </div> </div> </div> </div> </div>
                         <div id="principal-manage-expenses" class="dashboard-pane"> <div class="dashboard-content"> <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4"> <h2 class="h4"><i class="fas fa-receipt"></i>Manage Expenses</h2> <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addExpenseModal"><i class="fas fa-plus"></i> Add Expense</button> </div> <h3 class="h5 mt-4 text-secondary mb-3">Expense History</h3> <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th>Date</th> <th>Category</th> <th>Description</th> <th>Amount</th> <th>Actions</th> </tr> </thead> <tbody id="principalExpenseList"></tbody> </table> </div> </div> </div>
                         <div id="principal-attendance" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-calendar-check"></i>Attendance Records</h2> <div class="row mb-3"> <div class="col-md-6"> <label for="principalAttendanceClassSelect" class="form-label">Filter by Class:</label> <select id="principalAttendanceClassSelect" class="form-select"> <option value="">All Classes</option> </select> </div> </div> <div class="table-responsive mb-4"> <table class="table table-sm table-hover align-middle"> <thead> <tr> <th>Date</th> <th>Class</th> <th>Present</th> <th>Absent</th> <th>Details</th> </tr> </thead> <tbody id="principalAttendanceList"></tbody> </table> </div> <div class="chart-container mt-4"> <h5 class="text-center mb-3 text-secondary fw-normal">Class Attendance Trend</h5> <canvas id="principalClassAttendanceChart"></canvas> </div> </div> </div>
                         <div id="principal-results" class="dashboard-pane"> <div class="dashboard-content text-center"> <h2 class="h4 mb-4"><i class="fas fa-poll"></i>Manage Results</h2> <i class="fas fa-tools fa-3x text-muted my-4"></i> <p class="text-muted">This feature is currently under development.</p> </div> </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ==================== Teacher Dashboard View ==================== -->
    <div id="teacherDashboardView" class="view">
         <nav class="navbar navbar-expand-lg navbar-light fixed-top" style="background: #ffffff;"> <div class="container-fluid"> <button class="btn btn-link sidebar-toggler me-3 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#teacherSidebarOffcanvas"><i class="fas fa-bars"></i></button> <a class="navbar-brand" href="#" style="color: #11998e;"><i class="fas fa-chalkboard-teacher"></i> Teacher: <span id="teacherNameDisplay"></span> (<span id="teacherSchoolNameDisplay"></span>)</a> <div class="ms-auto"> <button id="teacherLogoutButton" class="btn btn-outline-danger btn-logout"><i class="fas fa-sign-out-alt me-1"></i> Logout</button> </div> </div> </nav>
        <div class="offcanvas offcanvas-start dashboard-sidebar" tabindex="-1" id="teacherSidebarOffcanvas" aria-labelledby="teacherSidebarLabel"> <div class="offcanvas-header border-bottom border-secondary"> <h5 class="offcanvas-title text-white" id="teacherSidebarLabel"><i class="fas fa-list-ul me-2"></i> Teacher Menu</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button> </div> <div class="offcanvas-body p-0"> <nav class="nav flex-column sidebar-sticky"> <a class="nav-link active" href="#teacher-dashboard-overview" data-view="teacher-dashboard-overview" data-bs-dismiss="offcanvas"> <i class="fas fa-home fa-fw"></i> Overview </a> <a class="nav-link" href="#teacher-take-attendance" data-view="teacher-take-attendance" data-bs-dismiss="offcanvas"> <i class="fas fa-user-check fa-fw"></i> Take Attendance </a> <a class="nav-link" href="#teacher-view-attendance" data-view="teacher-view-attendance" data-bs-dismiss="offcanvas"> <i class="fas fa-calendar-alt fa-fw"></i> View Attendance </a> <a class="nav-link" href="#teacher-view-students" data-view="teacher-view-students" data-bs-dismiss="offcanvas"> <i class="fas fa-users fa-fw"></i> My Students </a> <a class="nav-link" href="#teacher-profile" data-view="teacher-profile" data-bs-dismiss="offcanvas"> <i class="fas fa-id-card fa-fw"></i> My Profile </a> </nav> </div> </div>
         <div class="container-fluid">
            <div class="row">
                <nav id="teacherSidebar" class="col-md-3 col-lg-2 d-none d-md-block dashboard-sidebar"> <div class="position-sticky sidebar-sticky"> <ul class="nav flex-column"> <li class="nav-item"> <a class="nav-link active" href="#teacher-dashboard-overview" data-view="teacher-dashboard-overview"> <i class="fas fa-home fa-fw"></i> Overview </a> </li> <li class="nav-item"> <a class="nav-link" href="#teacher-take-attendance" data-view="teacher-take-attendance"> <i class="fas fa-user-check fa-fw"></i> Take Attendance </a> </li> <li class="nav-item"> <a class="nav-link" href="#teacher-view-attendance" data-view="teacher-view-attendance"> <i class="fas fa-calendar-alt fa-fw"></i> View Attendance </a> </li> <li class="nav-item"> <a class="nav-link" href="#teacher-view-students" data-view="teacher-view-students"> <i class="fas fa-users fa-fw"></i> My Students </a> </li> <li class="nav-item"> <a class="nav-link" href="#teacher-profile" data-view="teacher-profile"> <i class="fas fa-id-card fa-fw"></i> My Profile </a> </li> </ul> </div> </nav>
                 <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                     <div class="dashboard-tab-content pt-3 pb-2 mb-3">
                         <div id="teacher-dashboard-overview" class="dashboard-pane active"> <div class="dashboard-content border-0 p-0"> <h2 class="h4 mb-4 animate__animated animate__slideInDown"><i class="fas fa-columns"></i> Teacher Overview</h2> <p class="lead animate__animated animate__fadeIn" style="animation-delay: 0.1s;">Welcome, <span id="teacherNameWelcome"></span>!</p> <div class="row g-4 mb-4"> <div class="col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;"> <div class="card h-100"> <div class="card-header"><i class="fas fa-chalkboard-teacher text-info"></i>Assigned Classes</div> <div class="card-body p-2"> <ul id="teacherAssignedClassesList" class="list-group list-group-flush"><li class="list-group-item text-center p-3"><div class="spinner-border spinner-border-sm"></div></li></ul> </div> </div> </div> <div class="col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;"> <div class="card h-100"> <div class="card-header"><i class="fas fa-clipboard-check text-success"></i>Quick Stats</div> <div class="card-body d-flex flex-column justify-content-center p-4"> <p class="mb-2 fs-6"><i class="fas fa-users me-2 text-primary"></i>Total Students: <strong id="teacherTotalStudentsCount" class="fs-5">0</strong></p> <p class="mb-0 fs-6"><i class="fas fa-calendar-day me-2 text-warning"></i>Today's Attendance: <span id="teacherTodayAttendanceStatus" class="badge bg-secondary">...</span></p> </div> </div> </div> </div> <div class="row mt-4"> <div class="col-12 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;"> <div class="chart-container"> <h5 class="text-center mb-3 text-secondary fw-normal">Recent Attendance Summary</h5> <canvas id="teacherAttendanceSummaryChart"></canvas> </div> </div> </div> </div> </div>
                         <div id="teacher-take-attendance" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-user-check"></i>Take Attendance</h2> <form id="takeAttendanceForm" class="p-4 card shadow-sm"> <div class="row mb-3 g-3"> <div class="col-md-6"> <label for="attendanceClassSelect" class="form-label">Select Class</label> <select id="attendanceClassSelect" class="form-select form-select-lg" required> <option value="" selected disabled>-- Select Class --</option> </select> </div> <div class="col-md-6"> <label for="attendanceDate" class="form-label">Date</label> <input type="date" id="attendanceDate" class="form-control form-control-lg" required readonly> </div> </div> <div id="attendanceStudentListContainer" class="mt-4 animate__animated animate__fadeIn" style="display: none;"> <div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-light rounded shadow-sm"> <h3 class="h5 mb-0 text-primary">Mark Present Students</h3> <div class="form-check form-switch fs-5"> <input class="form-check-input" type="checkbox" role="switch" id="selectAllStudentsCheckbox"> <label class="form-check-label" for="selectAllStudentsCheckbox">Select All</label> </div> </div> <div id="attendanceStudentChecklist" class="list-group border rounded shadow-sm" style="max-height: 50vh; overflow-y: auto;"></div> <button type="submit" class="btn btn-success mt-3 w-100 btn-lg"><i class="fas fa-check-circle me-1"></i> Submit Attendance</button> </div> <p id="attendanceLoadingMessage" class="text-center mt-3 text-muted" style="display: none;"><div class="spinner-border spinner-border-sm me-2"></div>Loading students...</p> <p id="attendanceNoStudentsMessage" class="text-center mt-3 text-danger fw-bold" style="display: none;"><i class="fas fa-exclamation-triangle me-1"></i> No students found.</p> </form> </div> </div>
                         <div id="teacher-view-attendance" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-calendar-alt"></i>View Attendance Records</h2> <div class="row mb-3"> <div class="col-md-6"> <label for="viewAttendanceClassSelect" class="form-label">Filter by Class:</label> <select id="viewAttendanceClassSelect" class="form-select"> <option value="">All My Classes</option> </select> </div> </div> <div class="table-responsive mb-4"> <table class="table table-sm table-hover align-middle"> <thead> <tr> <th>Date</th> <th>Class</th> <th>Present <i class="fas fa-check-circle text-success"></i></th> <th>Absent <i class="fas fa-times-circle text-danger"></i></th> <th>Total</th> </tr> </thead> <tbody id="teacherAttendanceRecordList"></tbody> </table> </div> <div class="chart-container mt-4"> <h5 class="text-center mb-3 text-secondary fw-normal">Class Attendance Trend</h5> <canvas id="teacherClassAttendanceChart"></canvas> </div> </div> </div>
                         <div id="teacher-view-students" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-users"></i>My Students</h2> <div class="row mb-3"> <div class="col-md-6"> <label for="viewStudentClassSelect" class="form-label">Select Class:</label> <select id="viewStudentClassSelect" class="form-select"> <option value="" selected disabled>-- Select Class --</option> </select> </div> </div> <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th>Roll No</th> <th>Name</th> <th>Mobile</th> <th>Father's Name</th> <th>Photo</th> <th>Actions</th> </tr> </thead> <tbody id="teacherStudentList"></tbody> </table> </div> </div> </div>
                         <div id="teacher-profile" class="dashboard-pane"> <div class="dashboard-content"> <h2 class="h4 mb-4"><i class="fas fa-id-card"></i>My Profile</h2> <div class="card overflow-hidden"> <div class="card-body p-0"> <div class="row g-0"> <div class="col-md-4 text-center bg-light p-4 d-flex flex-column align-items-center justify-content-center border-end"> <img id="teacherProfilePhoto" src="https://via.placeholder.com/150?text=T" alt="Profile Photo" class="img-thumbnail rounded-circle mb-3 shadow-sm" style="width: 150px; height: 150px; object-fit: cover; border: 4px solid white"> <h4 id="teacherProfileName" class="mb-1 fw-bold text-primary">Teacher Name</h4> <p class="mb-0 text-muted">Staff ID: <span id="teacherProfileStaffID" class="fw-medium">N/A</span></p> <span id="teacherProfileStatus" class="badge mt-2 fs-6">N/A</span> </div> <div class="col-md-8 p-4 ps-md-5"> <h5 class="mb-4 text-secondary border-bottom pb-2">Contact Information</h5> <p><strong><i class="fas fa-mobile-alt text-secondary me-2 fa-fw"></i>Mobile:</strong> <span id="teacherProfileMobile">N/A</span></p> <p><strong><i class="fas fa-envelope text-secondary me-2 fa-fw"></i>Gmail:</strong> <span id="teacherProfileGmail">N/A</span></p> <h5 class="mt-4 mb-3 text-secondary border-bottom pb-2">Employment Details</h5> <p><strong><i class="fas fa-calendar-plus text-secondary me-2 fa-fw"></i>Joining Date:</strong> <span id="teacherProfileJoiningDate">N/A</span></p> <p><strong><i class="fas fa-money-check-alt text-secondary me-2 fa-fw"></i>Designated Salary:</strong> Rs <span id="teacherProfileSalary">N/A</span></p> </div> </div> </div> </div> </div> </div>
                    </div>
                </main>
            </div>
         </div>
    </div>

    <!-- ==================== Modals ==================== -->
    <!-- Add/Edit Modals (Structure largely unchanged, styling handled by CSS vars) -->
    <!-- Add Student Modal --> <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addStudentModalLabel"><i class="fas fa-user-plus me-2"></i>Add New Student</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addStudentForm"> <div class="row g-3"> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="studentName" placeholder="Full Name" required> <label for="studentName">Full Name*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="studentRoll" placeholder="Roll Number" required> <label for="studentRoll">Roll Number*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="tel" class="form-control" id="studentMobile" placeholder="Mobile Number"> <label for="studentMobile">Mobile Number</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="email" class="form-control" id="studentGmail" placeholder="Gmail"> <label for="studentGmail">Gmail (Optional)</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="password" class="form-control" id="studentPassword" placeholder="Password"> <label for="studentPassword">Password (Optional)</label> </div> </div> <div class="col-md-6"> <label for="studentClass" class="form-label small mb-1 ms-1">Class*</label> <select id="studentClass" class="form-select" required> <option value="" selected disabled>-- Select --</option> </select> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="studentFatherName" placeholder="Father's Name" required> <label for="studentFatherName">Father's Name*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="studentMotherName" placeholder="Mother's Name"> <label for="studentMotherName">Mother's Name</label> </div> </div> <div class="col-12"> <div class="form-floating"> <textarea class="form-control" id="studentAddress" placeholder="Address" required style="height: 80px;"></textarea> <label for="studentAddress">Address*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="studentAadhar" placeholder="Aadhar Number"> <label for="studentAadhar">Aadhar Number</label> </div> </div> <div class="col-md-6"> <label for="studentGender" class="form-label small mb-1 ms-1">Gender*</label> <select id="studentGender" class="form-select" required> <option value="" selected disabled>-- Select --</option> <option value="Male">Male</option> <option value="Female">Female</option> <option value="Other">Other</option> </select> </div> <div class="col-12"> <label for="studentPhoto" class="form-label small mb-1 ms-1">Student Photo</label> <input type="file" class="form-control" id="studentPhoto" accept="image/*"> <small class="form-text text-muted">Optional. Will be uploaded to GitHub.</small> </div> </div> <div class="modal-footer pb-0 px-0 mt-3"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-primary">Add Student</button> </div> </form> </div> </div> </div> </div>
    <!-- Add Staff Modal --> <div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addStaffModalLabel"><i class="fas fa-user-plus me-2"></i>Add Staff Member</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addStaffForm"> <div class="row g-3"> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="staffName" placeholder="Full Name" required> <label for="staffName">Full Name*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="tel" class="form-control" id="staffMobile" placeholder="Mobile Number" required> <label for="staffMobile">Mobile Number*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="email" class="form-control" id="staffGmail" placeholder="Gmail" required> <label for="staffGmail">Gmail*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="password" class="form-control" id="staffPassword" placeholder="Password" required> <label for="staffPassword">Password*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="number" step="0.01" class="form-control" id="staffSalary" placeholder="Salary Amount" required> <label for="staffSalary">Salary (Monthly)*</label> </div> </div> <div class="col-md-6"> <label for="staffPhoto" class="form-label small mb-1 ms-1">Staff Photo</label> <input type="file" class="form-control" id="staffPhoto" accept="image/*"> <small class="form-text text-muted">Optional. Will be uploaded.</small> </div> </div> <div class="modal-footer pb-0 px-0 mt-3"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-primary">Add Staff</button> </div> </form> </div> </div> </div> </div>
    <!-- Add Fee Type Modal --> <div class="modal fade" id="addFeeTypeModal" tabindex="-1" aria-labelledby="addFeeTypeModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addFeeTypeModalLabel"><i class="fas fa-tags me-2"></i>Add Fee Type</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addFeeTypeForm"> <div class="form-floating mb-3"> <input type="text" class="form-control" id="feeTypeName" placeholder="Fee Type Name" required> <label for="feeTypeName">Fee Type Name*</label> </div> <div class="form-floating mb-3"> <input type="number" step="0.01" class="form-control" id="feeTypeAmount" placeholder="Default Amount" required> <label for="feeTypeAmount">Default Amount*</label> </div> <div class="mb-3"> <label for="feeTypeFrequency" class="form-label small mb-1 ms-1">Frequency*</label> <select id="feeTypeFrequency" class="form-select" required> <option value="" selected disabled>-- Select --</option> <option value="Monthly">Monthly</option> <option value="Quarterly">Quarterly</option> <option value="Half-Yearly">Half-Yearly</option> <option value="Yearly">Yearly</option> <option value="One-Time">One-Time</option> </select> </div> <div class="modal-footer pb-0 px-0"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-info text-white">Add Fee Type</button> </div> </form> </div> </div> </div> </div>
    <!-- Add Student Fee Record Modal --> <div class="modal fade" id="addStudentFeeModal" tabindex="-1" aria-labelledby="addStudentFeeModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addStudentFeeModalLabel"><i class="fas fa-file-invoice-dollar me-2"></i>Add Student Fee</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addStudentFeeForm"> <div class="row g-3"> <div class="col-md-6"> <label for="feeStudentSelect" class="form-label small mb-1 ms-1">Select Student*</label> <select id="feeStudentSelect" class="form-select" required> <option>Loading...</option> </select> </div> <div class="col-md-6"> <label for="feeTypeSelect" class="form-label small mb-1 ms-1">Select Fee Type*</label> <select id="feeTypeSelect" class="form-select" required> <option>Loading...</option> </select> </div> <div class="col-md-6"> <div class="form-floating"> <input type="number" step="0.01" class="form-control" id="feeAmount" placeholder="Amount" required> <label for="feeAmount">Amount*</label> </div> </div> <div class="col-md-6"> <div class="form-floating"> <input type="text" class="form-control" id="feeAcademicYear" placeholder="Academic Year" required value="2024-2025"> <label for="feeAcademicYear">Academic Year*</label> </div> </div> <div class="col-md-6"> <label for="feeDueDate" class="form-label small mb-1 ms-1">Due Date*</label> <input type="date" class="form-control" id="feeDueDate" required> </div> <div class="col-md-6"> <label for="feePaidDate" class="form-label small mb-1 ms-1">Paid Date</label> <input type="date" class="form-control" id="feePaidDate"> </div> <div class="col-md-6"> <label for="feeStatus" class="form-label small mb-1 ms-1">Status*</label> <select id="feeStatus" class="form-select" required> <option value="Due">Due</option> <option value="Paid">Paid</option> <option value="Partial">Partial</option> </select> </div> <div class="col-md-6"> <div class="form-floating"> <textarea class="form-control" id="feeNotes" placeholder="Notes" style="height: 58px"></textarea> <label for="feeNotes">Notes</label> </div> </div> </div> <div class="modal-footer pb-0 px-0 mt-3"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-success">Add Record</button> </div> </form> </div> </div> </div> </div>
    <!-- Add Salary Payment Modal --> <div class="modal fade" id="addSalaryPaymentModal" tabindex="-1" aria-labelledby="addSalaryPaymentModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addSalaryPaymentModalLabel"><i class="fas fa-money-check-alt me-2"></i>Record Salary Payment</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addSalaryPaymentForm"> <div class="mb-3"> <label for="salaryStaffSelect" class="form-label small mb-1 ms-1">Select Staff*</label> <select id="salaryStaffSelect" class="form-select" required> <option>Loading...</option> </select> </div> <div class="form-floating mb-3"> <input type="number" step="0.01" class="form-control" id="salaryAmountPaid" placeholder="Amount Paid" required> <label for="salaryAmountPaid">Amount Paid*</label> </div> <div class="form-floating mb-3"> <input type="text" class="form-control" id="salaryMonthYear" placeholder="Month/Year" required> <label for="salaryMonthYear">For Month/Year*</label> </div> <div class="form-floating mb-3"> <textarea class="form-control" id="salaryNotes" placeholder="Notes" style="height: 80px"></textarea> <label for="salaryNotes">Notes</label> </div> <div class="modal-footer pb-0 px-0"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-success">Record Payment</button> </div> </form> </div> </div> </div> </div>
    <!-- Add Expense Modal --> <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="addExpenseModalLabel"><i class="fas fa-receipt me-2"></i>Add Expense</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="addExpenseForm"> <div class="form-floating mb-3"> <input type="text" class="form-control" id="expenseCategory" placeholder="Category" required> <label for="expenseCategory">Category*</label> </div> <div class="form-floating mb-3"> <textarea class="form-control" id="expenseDescription" placeholder="Description" required style="height: 80px;"></textarea> <label for="expenseDescription">Description*</label> </div> <div class="form-floating mb-3"> <input type="number" step="0.01" class="form-control" id="expenseAmount" placeholder="Amount" required> <label for="expenseAmount">Amount*</label> </div> <div class="modal-footer pb-0 px-0"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-warning">Add Expense</button> </div> </form> </div> </div> </div> </div>
    <!-- View Attendance Details Modal --> <div class="modal fade" id="viewAttendanceDetailsModal" tabindex="-1" aria-labelledby="viewAttendanceDetailsModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h1 class="modal-title fs-5" id="viewAttendanceDetailsModalLabel"><i class="fas fa-clipboard-list me-2"></i>Attendance Details</h1> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="alert alert-light fs-6"> <p class="mb-1"><strong><i class="fas fa-calendar-day me-1"></i> Date:</strong> <span id="modalAttendanceDate" class="fw-bold"></span></p> <p class="mb-0"><strong><i class="fas fa-chalkboard me-1"></i> Class:</strong> <span id="modalAttendanceClass" class="fw-bold"></span></p> </div> <div class="row g-4 mt-2"> <div class="col-md-6"> <h5 class="text-success"><i class="fas fa-user-check me-1"></i> Present (<span id="modalPresentCount">0</span>)</h5> <ul id="modalPresentList" class="list-group list-group-flush"></ul> </div> <div class="col-md-6"> <h5 class="text-danger"><i class="fas fa-user-times me-1"></i> Absent (<span id="modalAbsentCount">0</span>)</h5> <ul id="modalAbsentList" class="list-group list-group-flush"></ul> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>

    <!-- Student Profile Modal -->
    <div class="modal fade" id="studentProfileModal" tabindex="-1" aria-labelledby="studentProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="profile-modal-header">
             <img id="profileStudentPhoto" src="https://via.placeholder.com/120?text=S" alt="Student Photo" class="rounded-circle profile-modal-img">
             <h4 id="profileStudentName" class="mt-2 mb-0 text-white">Student Name</h4>
             <p class="mb-0 text-white-50">Class: <span id="profileStudentClass"></span> | Roll: <span id="profileStudentRoll"></span></p>
             <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
          </div>
          <div class="modal-body profile-modal-body">
                <div class="profile-section">
                    <h5><i class="fas fa-user-circle fa-fw text-primary me-2"></i>Basic Information</h5>
                    <div class="row profile-info g-2">
                        <div class="col-md-6"><p><strong><i class="fas fa-id-card fa-fw"></i>Student ID:</strong> <span id="profileStudentID"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-venus-mars fa-fw"></i>Gender:</strong> <span id="profileStudentGender"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-mobile-alt fa-fw"></i>Mobile:</strong> <span id="profileStudentMobile"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-envelope fa-fw"></i>Gmail:</strong> <span id="profileStudentGmail"></span></p></div>
                        <div class="col-12"><p><strong><i class="fas fa-map-marker-alt fa-fw"></i>Address:</strong> <span id="profileStudentAddress"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-address-card fa-fw"></i>Aadhar:</strong> <span id="profileStudentAadhar"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-calendar-alt fa-fw"></i>Registered:</strong> <span id="profileStudentRegDate"></span></p></div>
                    </div>
                </div>
                <div class="profile-section">
                    <h5><i class="fas fa-users fa-fw text-success me-2"></i>Parent Information</h5>
                     <div class="row profile-info g-2">
                        <div class="col-md-6"><p><strong><i class="fas fa-user fa-fw"></i>Father's Name:</strong> <span id="profileStudentFather"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-user fa-fw"></i>Mother's Name:</strong> <span id="profileStudentMother"></span></p></div>
                    </div>
                </div>
                 <div class="profile-section">
                    <h5><i class="fas fa-money-check-dollar fa-fw text-warning me-2"></i>Fee Records</h5>
                    <div id="profileStudentFeeRecords" class="profile-records-list">
                         <p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading fees...</p>
                    </div>
                </div>
                <div class="profile-section">
                     <h5><i class="fas fa-calendar-check fa-fw text-info me-2"></i>Attendance Summary</h5>
                     <div id="profileStudentAttendanceRecords" class="profile-records-list">
                         <p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading attendance...</p>
                     </div>
                 </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Edit Profile</button> -->
          </div>
        </div>
      </div>
    </div>

     <!-- Staff Profile Modal -->
    <div class="modal fade" id="staffProfileModal" tabindex="-1" aria-labelledby="staffProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="profile-modal-header" style="background: linear-gradient(135deg, #08aeea 0%, #2af598 100%);"> <!-- Different gradient -->
             <img id="profileStaffPhoto" src="https://via.placeholder.com/120?text=T" alt="Staff Photo" class="rounded-circle profile-modal-img">
             <h4 id="profileStaffName" class="mt-2 mb-0 text-white">Staff Name</h4>
             <p class="mb-0 text-white-50">Staff ID: <span id="profileStaffID"></span> | Status: <span id="profileStaffStatus" class="badge"></span></p>
             <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
          </div>
          <div class="modal-body profile-modal-body">
                <div class="profile-section">
                    <h5><i class="fas fa-address-card fa-fw text-primary me-2"></i>Contact Information</h5>
                    <div class="row profile-info g-2">
                        <div class="col-md-6"><p><strong><i class="fas fa-mobile-alt fa-fw"></i>Mobile:</strong> <span id="profileStaffMobile"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-envelope fa-fw"></i>Gmail:</strong> <span id="profileStaffGmail"></span></p></div>
                    </div>
                </div>
                <div class="profile-section">
                    <h5><i class="fas fa-briefcase fa-fw text-success me-2"></i>Employment Details</h5>
                     <div class="row profile-info g-2">
                        <div class="col-md-6"><p><strong><i class="fas fa-calendar-alt fa-fw"></i>Joining Date:</strong> <span id="profileStaffJoiningDate"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-money-check-alt fa-fw"></i>Designated Salary:</strong> <span id="profileStaffDesignatedSalary"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-hand-holding-usd fa-fw"></i>Total Paid:</strong> <span id="profileStaffTotalPaid"></span></p></div>
                        <div class="col-md-6"><p><strong><i class="fas fa-file-invoice-dollar fa-fw"></i>Total Dues:</strong> <span id="profileStaffTotalDues"></span></p></div>
                    </div>
                </div>
                 <div class="profile-section">
                    <h5><i class="fas fa-money-check-dollar fa-fw text-warning me-2"></i>Salary Payment History</h5>
                    <div id="profileStaffSalaryRecords" class="profile-records-list">
                         <p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading payments...</p>
                    </div>
                </div>
                 <!-- Add Attendance Section if needed for staff -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Edit Profile</button> -->
          </div>
        </div>
      </div>
    </div>


    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Frontend JavaScript (Only Rendering and Profile Modal Logic Added) -->
    <script>
        // --- Configuration ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwb6aCBWknDn0swuy7YqkqOZHyYqy29JAe1Y5helQsqxt7Wq5OEwkLLxJ5Xd0MJms8Y/exec';

        // --- Global Variables ---
        let currentView = 'loginView'; let principalSpreadsheetId = null; let schoolName = null; let teacherSpreadsheetId = null; let teacherStaffId = null; let teacherName = null; let teacherAssignedClasses = []; let principalAllStudents = []; let principalAllStaff = []; let principalAllFeeTypes = []; let principalAllClasses = []; let principalAllSubjects = []; let chartInstances = {};

        // --- Utility Functions ---
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'animate__animated', 'animate__fadeIn')); const t = document.getElementById(viewId); if(t) t.classList.add('active', 'animate__animated', 'animate__fadeIn'); currentView = viewId; if (viewId === 'principalDashboardView') { activateDashboardPane('principal-dashboard-overview'); loadPrincipalDashboard(); setTimeout(() => window.dispatchEvent(new Event('resize')), 400); } else if (viewId === 'teacherDashboardView') { activateDashboardPane('teacher-dashboard-overview'); loadTeacherDashboard(); setTimeout(() => window.dispatchEvent(new Event('resize')), 400); } window.scrollTo(0, 0); }
        function showLoading(show = true) { document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none'; }
        function showAlert(message, type = 'info', duration = 4000) { const a = document.getElementById('alertArea'); const i = `alert-${Date.now()}`; const c = type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-triangle' : type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle'; const h = `<div id="${i}" class="alert alert-${type} alert-dismissible fade show animate__animated animate__bounceInRight" role="alert" style="min-width: 250px;"><i class="fas ${c} me-2"></i>${message}<button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button></div>`; a.insertAdjacentHTML('beforeend', h); setTimeout(() => { const e = document.getElementById(i); if (e) { e.classList.remove('animate__bounceInRight'); e.classList.add('animate__animated','animate__fadeOutUp'); e.addEventListener('animationend', () => bootstrap.Alert.getOrCreateInstance(e)?.close(), { once: true }); } }, duration); }
        function readFileAsBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        function formatDate(dateString) { if (!dateString || dateString instanceof Date === false && new Date(dateString).toString() === 'Invalid Date') return 'N/A'; try { const date = dateString instanceof Date ? dateString : new Date(dateString); if (isNaN(date.getTime())) return 'N/A'; return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }); } catch (e) { return 'N/A'; } }
        function formatCurrency(amount) { const num = parseFloat(amount); if (isNaN(num)) return 'Rs 0.00'; return `Rs ${num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }

        // --- Backend Interaction ---
        async function callBackendAPI(action, payload = {}) { showLoading(true); const btn = document.querySelector(`button[type="submit"]:not(:disabled), button[data-action="${action}"]:not(:disabled)`); if(btn) btn.classList.add('button-loading'); console.log(`API Call: ${action}`, payload); try { const response = await fetch(WEB_APP_URL, { method: 'POST', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, payload }) }); showLoading(false); if(btn) btn.classList.remove('button-loading'); if (!response.ok) { let eMsg = `HTTP error ${response.status}`; try { const eData = await response.json(); eMsg = eData.message || JSON.stringify(eData); } catch (err) { eMsg = `${response.status} ${response.statusText}`; } console.error(`API Error (${action}):`, eMsg); showAlert(`Error: ${eMsg}`, 'danger'); return { success: false, message: eMsg }; } const result = await response.json(); console.log(`API Resp (${action}):`, result); if (result && result.success === false) { console.error(`Backend fail (${action}):`, result.message); showAlert(result.message || `Operation failed: ${action}`, 'danger'); } else if (result && result.success === true && ['addStudent', 'addStaff', 'addFeeType', 'addStudentFee', 'addSalaryPayment', 'addExpense', 'recordAttendance', 'registerSchool'].includes(action)) { showAlert(result.message || `${action.replace(/([A-Z])/g, ' $1').trim()} successful.`, 'success'); } return result; } catch (error) { showLoading(false); if(btn) btn.classList.remove('button-loading'); console.error(`Network error (${action}):`, error); showAlert(`Network error: ${error.message}`, 'danger'); return { success: false, message: `Network error: ${error.message}` }; } }

        // --- Initialization & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => { setupEventListeners(); if (!WEB_APP_URL || !WEB_APP_URL.startsWith('https://script.google.com/macros/s/')) showAlert("Backend URL Error!", "danger", 15000); else console.log("API Ready:", WEB_APP_URL); });
        function setupEventListeners() { document.getElementById('registrationForm')?.addEventListener('submit', handleRegistration); document.getElementById('principalLoginForm')?.addEventListener('submit', handlePrincipalLogin); document.getElementById('teacherLoginForm')?.addEventListener('submit', handleTeacherLogin); document.getElementById('addStudentForm')?.addEventListener('submit', handleAddStudent); document.getElementById('addStaffForm')?.addEventListener('submit', handleAddStaff); document.getElementById('addFeeTypeForm')?.addEventListener('submit', handleAddFeeType); document.getElementById('addStudentFeeForm')?.addEventListener('submit', handleAddStudentFee); document.getElementById('addSalaryPaymentForm')?.addEventListener('submit', handleAddSalaryPayment); document.getElementById('addExpenseForm')?.addEventListener('submit', handleAddExpense); document.getElementById('takeAttendanceForm')?.addEventListener('submit', handleTakeAttendanceSubmit); const pR = document.getElementById('passwordReg'), cPR = document.getElementById('confirmPasswordReg'), mE = document.getElementById('passwordMismatchError'); if (cPR && pR) { const cP = () => { if (pR.value && cPR.value && pR.value !== cPR.value) { mE.style.display = 'block'; cPR.setCustomValidity("!"); } else { mE.style.display = 'none'; cPR.setCustomValidity(""); } }; cPR.addEventListener('input', cP); pR.addEventListener('input', cP); } document.getElementById('logoutButton')?.addEventListener('click', handleLogout); document.getElementById('teacherLogoutButton')?.addEventListener('click', handleLogout); setupSidebarNavigation('principalSidebar', loadPrincipalTabData); setupSidebarNavigation('principalSidebarOffcanvas', loadPrincipalTabData); setupSidebarNavigation('teacherSidebar', loadTeacherTabData); setupSidebarNavigation('teacherSidebarOffcanvas', loadTeacherTabData); document.getElementById('principalAttendanceClassSelect')?.addEventListener('change', handlePrincipalAttendanceFilter); document.getElementById('attendanceClassSelect')?.addEventListener('change', handleAttendanceClassChange); document.getElementById('selectAllStudentsCheckbox')?.addEventListener('change', handleSelectAllStudents); document.getElementById('viewAttendanceClassSelect')?.addEventListener('change', handleTeacherAttendanceFilter); document.getElementById('viewStudentClassSelect')?.addEventListener('change', handleTeacherStudentFilter); document.getElementById('studentClassFilter')?.addEventListener('change', handlePrincipalStudentFilter); const fTS = document.getElementById('feeTypeSelect'); if (fTS) fTS.addEventListener('change', (e) => { const a = e.target.options[e.target.selectedIndex]?.getAttribute('data-amount'); const i = document.getElementById('feeAmount'); if (i && a) i.value = a; }); document.body.addEventListener('click', function(event) { if (event.target.closest('.view-attendance-details')) { showAttendanceDetailsModal(event); } else if (event.target.closest('.copy-id-btn')) { handleCopyId(event); } else if (event.target.closest('.view-student-profile-btn')) { const studentId = event.target.closest('.view-student-profile-btn').dataset.studentId; showStudentProfile(studentId); } else if (event.target.closest('.view-staff-profile-btn')) { const staffId = event.target.closest('.view-staff-profile-btn').dataset.staffId; showStaffProfile(staffId); } }); }
        function setupSidebarNavigation(sidebarId, tabLoadFunction) { const s = document.getElementById(sidebarId); if (s) { s.addEventListener('click', (e) => { const l = e.target.closest('.nav-link'); if (l && l.dataset.view) { e.preventDefault(); const pId = l.dataset.view; document.querySelectorAll(`#principalSidebar .nav-link, #principalSidebarOffcanvas .nav-link, #teacherSidebar .nav-link, #teacherSidebarOffcanvas .nav-link`).forEach(lnk => lnk.classList.remove('active')); document.querySelectorAll(`.nav-link[data-view="${pId}"]`).forEach(el => el.classList.add('active')); activateDashboardPane(pId); tabLoadFunction(pId); const offcanvasEl = document.getElementById(sidebarId); if (offcanvasEl && offcanvasEl.classList.contains('offcanvas')) bootstrap.Offcanvas.getInstance(offcanvasEl)?.hide(); } }); } }
        function activateDashboardPane(paneId) { document.querySelectorAll('.dashboard-pane').forEach(p => p.classList.remove('active', 'animate__animated', 'animate__fadeIn')); const tP = document.getElementById(paneId); if (tP) { tP.classList.add('active', 'animate__animated', 'animate__fadeIn'); } else { console.warn("Pane not found:", paneId); const oP = document.getElementById('principal-dashboard-overview') || document.getElementById('teacher-dashboard-overview'); if(oP) oP.classList.add('active'); } }

        // --- Handlers ---
        async function handleRegistration(e) { e.preventDefault(); const f = e.target; const sN = f.schoolName.value.trim(), pN = f.principalName.value.trim(), pM = f.principalMobileReg.value.trim(), pG = f.principalGmail.value.trim(), p = f.passwordReg.value, cP = f.confirmPasswordReg.value, sA = f.schoolAddress.value.trim(), w = f.website.value.trim(), sF = f.schoolImage.files[0]; if (p !== cP) { showAlert('Passwords do not match!', 'danger'); return; } if (!sN || !pN || !pM || !pG || !p || !sA) { showAlert('Please fill required fields.', 'warning'); return; } let iI = null; if (sF) { try { iI = { name: sF.name, type: sF.type, data: await readFileAsBase64(sF) }; } catch (err) { showAlert(`Error reading image: ${err.message}`, 'danger'); return; } } const sI = { schoolName: sN, principalName: pN, principalMobile: pM, principalGmail: pG, password: p, schoolAddress: sA, website: w, schoolImage: iI }; const r = await callBackendAPI('registerSchool', sI); if (r && r.success) { f.reset(); bootstrap.Tab.getOrCreateInstance(document.getElementById('pills-principal-login-tab')).show(); } }
        async function handlePrincipalLogin(e) { e.preventDefault(); const m = document.getElementById('principalMobile').value.trim(), p = document.getElementById('principalPassword').value; if (!m || !p) { showAlert('Enter mobile & password.', 'warning'); return; } const r = await callBackendAPI('principalLogin', { mobile: m, password: p }); if (r && r.success) { principalSpreadsheetId = r.spreadsheetId; schoolName = r.schoolName; document.getElementById('principalSchoolName').textContent = schoolName; showView('principalDashboardView'); } }
        async function handleTeacherLogin(e) { e.preventDefault(); const sG = document.getElementById('teacherSchoolGmail').value.trim(), sId = document.getElementById('teacherStaffId').value.trim(), p = document.getElementById('teacherPassword').value; if (!sG || !sId || !p) { showAlert('Fill all fields.', 'warning'); return; } const r = await callBackendAPI('teacherLogin', { schoolGmail: sG, staffId: sId, password: p }); if (r && r.success) { teacherSpreadsheetId = r.spreadsheetId; teacherStaffId = r.staffId; teacherName = r.teacherName; schoolName = r.schoolName; teacherAssignedClasses = r.assignedClasses || []; document.getElementById('teacherNameDisplay').textContent = teacherName; document.getElementById('teacherSchoolNameDisplay').textContent = schoolName; showView('teacherDashboardView'); } }
        function handleLogout() { principalSpreadsheetId = null; schoolName = null; teacherSpreadsheetId = null; teacherStaffId = null; teacherName = null; teacherAssignedClasses = []; principalAllStudents = []; principalAllStaff = []; principalAllFeeTypes = []; principalAllClasses = []; principalAllSubjects = []; document.getElementById('principalSchoolName').textContent = ''; document.getElementById('teacherNameDisplay').textContent = ''; document.getElementById('teacherSchoolNameDisplay').textContent = ''; destroyAllCharts(); showView('loginView'); showAlert('Logged out.', 'info'); document.getElementById('principalLoginForm')?.reset(); document.getElementById('teacherLoginForm')?.reset(); document.getElementById('registrationForm')?.reset(); const lT = document.getElementById('pills-principal-login-tab'); if (lT) bootstrap.Tab.getOrCreateInstance(lT).show(); }
        async function handleAddStudent(e) { e.preventDefault(); const f = e.target; const sI = { name: f.studentName.value.trim(), rollNumber: f.studentRoll.value.trim(), mobile: f.studentMobile.value.trim(), gmail: f.studentGmail.value.trim(), password: f.studentPassword.value, fatherName: f.studentFatherName.value.trim(), motherName: f.studentMotherName.value.trim(), classId: f.studentClass.value, address: f.studentAddress.value.trim(), aadhar: f.studentAadhar.value.trim(), gender: f.studentGender.value }; if (!sI.name || !sI.rollNumber || !sI.fatherName || !sI.classId || !sI.address || !sI.gender) { showAlert('Fill required fields.', 'warning'); return; } const sPF = f.studentPhoto.files[0]; let iI = null; if (sPF) { try { iI = { name: sPF.name, type: sPF.type, data: await readFileAsBase64(sPF) }; } catch (err) { showAlert(`Photo error: ${err.message}`, 'danger'); return; } } const r = await callBackendAPI('addStudent', { spreadsheetId: principalSpreadsheetId, studentInfo: sI, imageInfo: iI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalStudents(); } }
        async function handleAddStaff(e) { e.preventDefault(); const f = e.target; const sI = { name: f.staffName.value.trim(), mobile: f.staffMobile.value.trim(), gmail: f.staffGmail.value.trim(), password: f.staffPassword.value, salaryAmount: f.staffSalary.value }; if (!sI.name || !sI.mobile || !sI.gmail || !sI.password || !sI.salaryAmount) { showAlert('Fill required fields.', 'warning'); return; } const sPF = f.staffPhoto.files[0]; let iI = null; if (sPF) { try { iI = { name: sPF.name, type: sPF.type, data: await readFileAsBase64(sPF) }; } catch (err) { showAlert(`Photo error: ${err.message}`, 'danger'); return; } } const r = await callBackendAPI('addStaff', { spreadsheetId: principalSpreadsheetId, staffInfo: sI, imageInfo: iI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalStaff(); loadPrincipalDashboardOverview(); loadPrincipalSalaryData(); } }
        async function handleAddFeeType(e) { e.preventDefault(); const f = e.target; const fTI = { name: f.feeTypeName.value.trim(), amount: f.feeTypeAmount.value, frequency: f.feeTypeFrequency.value }; if (!fTI.name || !fTI.amount || !fTI.frequency) { showAlert('Fill all fields.', 'warning'); return; } const r = await callBackendAPI('addFeeType', { spreadsheetId: principalSpreadsheetId, feeTypeInfo: fTI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalFeeTypes(); } }
        async function handleAddStudentFee(e) { e.preventDefault(); const f = e.target; const fI = { studentId: f.feeStudentSelect.value, feeTypeId: f.feeTypeSelect.value, amount: f.feeAmount.value, academicYear: f.feeAcademicYear.value.trim(), dueDate: f.feeDueDate.value, paidDate: f.feePaidDate.value || null, status: f.feeStatus.value, notes: f.feeNotes.value.trim() }; if (!fI.studentId || !fI.feeTypeId || !fI.amount || !fI.academicYear || !fI.dueDate) { showAlert('Fill required fields.', 'warning'); return; } if (fI.status === 'Paid' && !fI.paidDate) { showAlert('Provide Paid Date.', 'warning'); return; } const r = await callBackendAPI('addStudentFee', { spreadsheetId: principalSpreadsheetId, feeInfo: fI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalFeeRecords(); loadPrincipalDashboardOverview(); } }
        async function handleAddSalaryPayment(e) { e.preventDefault(); const f = e.target; const sI = { staffId: f.salaryStaffSelect.value, amount: f.salaryAmountPaid.value, monthYear: f.salaryMonthYear.value.trim(), notes: f.salaryNotes.value.trim() }; if (!sI.staffId || !sI.amount || !sI.monthYear) { showAlert('Fill required fields.', 'warning'); return; } const r = await callBackendAPI('addStaffSalaryPayment', { spreadsheetId: principalSpreadsheetId, salaryInfo: sI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalSalaryData(); loadPrincipalDashboardOverview(); } }
        async function handleAddExpense(e) { e.preventDefault(); const f = e.target; const eI = { category: f.expenseCategory.value.trim(), description: f.expenseDescription.value.trim(), amount: f.expenseAmount.value }; if (!eI.category || !eI.description || !eI.amount) { showAlert('Fill all fields.', 'warning'); return; } const r = await callBackendAPI('addExpense', { spreadsheetId: principalSpreadsheetId, expenseInfo: eI }); if (r && r.success) { f.reset(); bootstrap.Modal.getInstance(f.closest('.modal'))?.hide(); loadPrincipalExpenses(); loadPrincipalDashboardOverview(); } }
        async function handleAttendanceClassChange() { const cS=document.getElementById('attendanceClassSelect'), sLC=document.getElementById('attendanceStudentListContainer'), sCL=document.getElementById('attendanceStudentChecklist'), lM=document.getElementById('attendanceLoadingMessage'), nSM=document.getElementById('attendanceNoStudentsMessage'), sAC=document.getElementById('selectAllStudentsCheckbox'); if(sAC)sAC.checked=false; const sId=cS.value; sCL.innerHTML=''; sLC.style.display='none'; lM.style.display='none'; nSM.style.display='none'; if (!sId) return; lM.style.display='block'; const r=await callBackendAPI('getStudentsForClass', { spreadsheetId: teacherSpreadsheetId, classId: sId }); lM.style.display='none'; if (r && r.success && r.data && r.data.length > 0) { sLC.style.display='block'; sCL.innerHTML = r.data.map(s => { const id=s.StudentID, rn=s.RollNumber, n=s.Name; if (!id) return ''; return `<label class="list-group-item d-flex justify-content-between align-items-center animate__animated animate__fadeIn list-group-item-action"><div><input class="form-check-input me-2 student-attendance-checkbox" type="checkbox" value="${id}" id="student_${id}"><span class="fw-bold">${rn||'N/R'}</span> - ${n||'N/A'}</div><small class="text-muted">ID: ${id.substring(0,6)}</small></label>`; }).join(''); } else if (r && r.data && r.data.length === 0) nSM.style.display='block'; else showAlert(`Student load failed. ${r?.message || ''}`, 'danger'); }
        function handleSelectAllStudents() { const sAC=document.getElementById('selectAllStudentsCheckbox'); document.querySelectorAll('.student-attendance-checkbox').forEach(cb => cb.checked = sAC.checked); }
        async function handleTakeAttendanceSubmit(e) { e.preventDefault(); const f=e.target, cId=f.attendanceClassSelect.value; if (!cId) { showAlert('Select class.', 'warning'); return; } const pIds=[], aIds=[]; const allCB=document.querySelectorAll('.student-attendance-checkbox'); if (allCB.length === 0) { showAlert('No students loaded.', 'warning'); return; } allCB.forEach(cb => (cb.checked ? pIds : aIds).push(cb.value)); const aI={ classId: cId, presentStudentIds: pIds, absentStudentIds: aIds }; const r=await callBackendAPI('recordAttendance', { spreadsheetId: teacherSpreadsheetId, attendanceInfo: aI }); if (r && r.success) { f.reset(); document.getElementById('attendanceStudentListContainer').style.display='none'; document.getElementById('attendanceStudentChecklist').innerHTML=''; loadTeacherTabData('teacher-dashboard-overview'); loadTeacherAttendanceRecords(); } }
        function handlePrincipalStudentFilter() { loadPrincipalStudents(); } function handlePrincipalAttendanceFilter() { loadPrincipalAttendanceData(); } function handleTeacherAttendanceFilter() { loadTeacherAttendanceRecords(); } function handleTeacherStudentFilter() { const sId = document.getElementById('viewStudentClassSelect').value; loadTeacherStudentsByClass(sId); }
        function handleCopyId(e) { const b = e.target.closest('.copy-id-btn'); const id = b.dataset.id; const f = b.querySelector('.copy-feedback'); navigator.clipboard.writeText(id).then(() => { if(f) { f.textContent = 'Copied!'; f.style.display = 'inline'; setTimeout(() => { f.style.display = 'none'; f.textContent = ''; }, 1500); } else showAlert('ID Copied!', 'success', 1500); }).catch(err => showAlert('Copy failed.', 'warning')); }

        // --- Data Loading & Rendering ---
        function loadPrincipalDashboard() { loadPrincipalDashboardOverview(); loadPrincipalClassesForDropdowns(); loadPrincipalStudentsForDropdowns(); loadPrincipalStaffForDropdowns(); } // Preload more
        async function loadPrincipalDashboardOverview() { const r = await callBackendAPI('getPrincipalDashboardData', { spreadsheetId: principalSpreadsheetId }); if (r && r.success) { document.getElementById('statTotalStudents').textContent = r.stats.totalStudents || 0; document.getElementById('statTotalStaff').textContent = r.stats.totalStaff || 0; document.getElementById('statTotalClasses').textContent = r.stats.totalClasses || 0; document.getElementById('statTotalIncome').textContent = formatCurrency(r.financials.totalIncome); document.getElementById('statTotalExpenses').textContent = formatCurrency(r.financials.totalExpenses); document.getElementById('statTotalSalaryPaid').textContent = formatCurrency(r.financials.totalSalaryPaid); document.getElementById('statNetBalance').textContent = formatCurrency(r.financials.netBalance); principalAllStudents = r.students?.data || []; principalAllStaff = r.staff?.data || []; principalAllClasses = r.classes?.data || []; renderPrincipalOverviewCharts(r.attendance, r.financials); } }
        function loadPrincipalTabData(tId) { console.log("Loading principal tab:", tId); switch (tId) { case 'principal-dashboard-overview': loadPrincipalDashboardOverview(); break; case 'principal-manage-students': loadPrincipalStudents(); loadPrincipalClassesForDropdowns(['studentClass', 'studentClassFilter']); break; case 'principal-manage-staff': loadPrincipalStaff(); break; case 'principal-manage-classes': loadPrincipalClassesAndSubjects(); break; case 'principal-manage-fees': loadPrincipalFeeTypes(); loadPrincipalFeeRecords(); break; case 'principal-manage-salary': loadPrincipalSalaryData(); break; case 'principal-manage-expenses': loadPrincipalExpenses(); break; case 'principal-attendance': loadPrincipalAttendanceData(); break; case 'principal-results': break; } }
        async function loadPrincipalStudents() { const tBody = document.getElementById('principalStudentList'); tBody.innerHTML = '<tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>'; const filterClassId = document.getElementById('studentClassFilter').value; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Students' }); principalAllStudents = r?.success ? (r.data || []) : []; if (r && r.success) { const filteredStudents = filterClassId ? principalAllStudents.filter(s => s.Class === filterClassId) : principalAllStudents; renderTable(tBody, filteredStudents, [], (s) => { const cls = principalAllClasses.find(c => c.ClassID === s.Class); const clsName = cls ? `${cls.ClassName} ${cls.Section || ''}` : s.Class; const photo = `<img src="${s.PhotoURL || 'https://via.placeholder.com/40?text=S'}" alt="Photo" width="40" height="40" class="rounded-circle">`; const fullId = s.StudentID || ''; const shortId = fullId.substring(0, 8)+'...' || 'N/A'; const copyBtn = `<button class="btn btn-outline-secondary btn-copy copy-id-btn" data-id="${fullId}" title="Copy ID"><i class="fas fa-copy fa-xs"></i><span class="copy-feedback"></span></button>`; const actions = `<button class="btn btn-sm btn-outline-primary me-1 view-student-profile-btn" data-student-id="${fullId}" title="View Profile"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash"></i></button>`; return [`<span title="${fullId}">${shortId}</span>${copyBtn}`, s.RollNumber || 'N/A', s.Name || 'N/A', clsName, s.Mobile || 'N/A', photo, actions]; }, 7); /* Reduced colspan */ } else { tBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-4">Failed loading students. ${r?.message || ''}</td></tr>`; } }
        async function loadPrincipalStaff() { const tBody = document.getElementById('principalStaffList'); tBody.innerHTML = '<tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>'; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Staffs' }); principalAllStaff = r?.success ? (r.data || []) : []; if (r && r.success) { renderTable(tBody, r.data, [], (s) => { const isActive = s.IsActive === true || String(s.IsActive).toUpperCase() === 'TRUE'; const status = `<span class="badge bg-${isActive ? 'success' : 'secondary'}">${isActive ? 'Active' : 'Inactive'}</span>`; const photo = `<img src="${s.PhotoURL || 'https://via.placeholder.com/40?text=T'}" alt="Photo" width="40" height="40" class="rounded-circle">`; const fullId = s.StaffID || ''; const shortId = fullId.substring(0, 8)+'...' || 'N/A'; const copyBtn = `<button class="btn btn-outline-secondary btn-copy copy-id-btn" data-id="${fullId}" title="Copy ID"><i class="fas fa-copy fa-xs"></i><span class="copy-feedback"></span></button>`; const actions = `<button class="btn btn-sm btn-outline-primary me-1 view-staff-profile-btn" data-staff-id="${fullId}" title="View Profile"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-warning me-1" title="Toggle Active (Not Impl.)"><i class="fas fa-power-off"></i></button><button class="btn btn-sm btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash"></i></button>`; return [`<span title="${fullId}">${shortId}</span>${copyBtn}`, s.Name || 'N/A', s.Mobile || 'N/A', formatDate(s.JoiningDate), status, photo, actions]; }, 7); /* Reduced colspan */ } else { tBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-4">Failed loading staff. ${r?.message || ''}</td></tr>`; } }
        async function loadPrincipalClassesAndSubjects() { const cLU = document.getElementById('principalClassList'); cLU.innerHTML = '<li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li>'; const sLU = document.getElementById('principalSubjectList'); sLU.innerHTML = '<li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li>'; const aLD = document.getElementById('principalTeacherAssignmentList'); aLD.innerHTML = '<p class="text-center p-3"><div class="spinner-border spinner-border-sm"></div> Loading...</p>'; try { const [cR, sR, aR] = await Promise.all([callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Classes' }), callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Subjects' }), callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'ClassSubjects'})]); principalAllClasses = cR?.success ? (cR.data || []) : []; if (cR && cR.success) { if (principalAllClasses.length > 0) { const sM = principalAllStaff.reduce((m, s) => (m[s.StaffID] = s.Name, m), {}); cLU.innerHTML = principalAllClasses.sort((a, b) => (a.ClassName + (a.Section || '')).localeCompare(b.ClassName + (b.Section || ''))).map(c => `<li class="list-group-item"><strong>${c.ClassName} ${c.Section || ''}</strong> <small class="text-muted d-block">Teacher: ${sM[c.ClassTeacherStaffID] || 'N/A'}</small></li>`).join(''); } else { cLU.innerHTML = '<li class="list-group-item text-center text-muted">No classes found.</li>'; } } else { cLU.innerHTML = `<li class="list-group-item text-center text-danger">Failed loading.</li>`; } principalAllSubjects = sR?.success ? (sR.data || []) : []; if (sR && sR.success) { if (principalAllSubjects.length > 0) { sLU.innerHTML = principalAllSubjects.sort((a, b) => a.SubjectName.localeCompare(b.SubjectName)).map(s => `<li class="list-group-item">${s.SubjectName}</li>`).join(''); } else { sLU.innerHTML = '<li class="list-group-item text-center text-muted">No subjects found.</li>'; } } else { sLU.innerHTML = `<li class="list-group-item text-center text-danger">Failed loading.</li>`; } if (aR && aR.success) { const assigns = aR.data || []; if(assigns.length > 0) { const cM = principalAllClasses.reduce((m, c) => (m[c.ClassID] = `${c.ClassName} ${c.Section || ''}`, m), {}); const sM = principalAllSubjects.reduce((m, s) => (m[s.SubjectID] = s.SubjectName, m), {}); const stM = principalAllStaff.reduce((m, s) => (m[s.StaffID] = s.Name, m), {}); let tH = `<table class="table table-sm table-hover align-middle"><thead><tr><th>Class</th><th>Subject</th><th>Teacher</th><th>Actions</th></tr></thead><tbody>`; assigns.forEach(a => { const cN = cM[a.ClassID] || `...`; const sN = sM[a.SubjectID] || `...`; const tN = stM[a.StaffID] || `...`; const acts = `<button class="btn btn-xs btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash-alt fa-xs"></i></button>`; tH += `<tr><td>${cN}</td><td>${sN}</td><td>${tN}</td><td>${acts}</td></tr>`; }); tH += `</tbody></table>`; aLD.innerHTML = tH; } else { aLD.innerHTML = '<p class="text-center text-muted p-3">No assignments found.</p>'; } } else { aLD.innerHTML = '<p class="text-center text-danger p-3">Failed loading assignments.</p>'; } } catch (err) { console.error("Load Classes/Subjects Error:", err); cLU.innerHTML = '<li class="text-danger">Error</li>'; sLU.innerHTML = '<li class="text-danger">Error</li>'; aLD.innerHTML = '<p class="text-danger">Error</p>'; } }
        async function loadPrincipalFeeTypes() { const fTLU = document.getElementById('principalFeeTypeList'); fTLU.innerHTML = '<li class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></li>'; const fTS = document.getElementById('feeTypeSelect'); if (fTS) fTS.innerHTML = '<option>Loading...</option>'; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'FeeTypes' }); principalAllFeeTypes = r?.success ? (r.data || []) : []; if (r && r.success) { if (principalAllFeeTypes.length > 0) { fTLU.innerHTML = ''; let oH = ''; principalAllFeeTypes.forEach(ft => { fTLU.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${ft.FeeTypeName} (${ft.Frequency}) - ${formatCurrency(ft.DefaultAmount)}</span><button class="btn btn-xs btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash-alt fa-xs"></i></button></li>`; oH += `<option value="${ft.FeeTypeID}" data-amount="${ft.DefaultAmount}">${ft.FeeTypeName}</option>`; }); if (fTS) fTS.innerHTML = '<option value="" selected disabled>-- Select --</option>' + oH; } else { fTLU.innerHTML = '<li class="list-group-item text-muted">No types.</li>'; if (fTS) fTS.innerHTML = '<option disabled>-- No Types --</option>'; } } else { fTLU.innerHTML = `<li class="list-group-item text-danger">Failed loading.</li>`; if (fTS) fTS.innerHTML = '<option disabled>-- Error --</option>'; } }
        async function loadPrincipalFeeRecords() { const lB = document.getElementById('principalStudentFeeList'); lB.innerHTML = '<tr><td colspan="6" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'StudentsFees' }); if (r && r.success) { const fRs = r.data || []; const sM = principalAllStudents.reduce((m, s) => (m[s.StudentID] = s.Name, m), {}); const fTM = principalAllFeeTypes.reduce((m, f) => (m[f.FeeTypeID] = f.FeeTypeName, m), {}); renderTable(lB, fRs, [], (rec) => { const sN = sM[rec.StudentID] || `ID: ${rec.StudentID?.substring(0, 6)}...`; const fN = fTM[rec.FeeTypeID] || `ID: ${rec.FeeTypeID?.substring(0, 6)}...`; let b = rec.Status === 'Paid' ? 'success' : rec.Status === 'Partial' ? 'warning' : rec.Status === 'Due' ? 'danger' : 'secondary'; const st = `<span class="badge bg-${b}">${rec.Status}</span>`; const acts = `<button class="btn btn-xs btn-outline-primary me-1" title="Edit (Not Impl.)"><i class="fas fa-edit fa-xs"></i></button><button class="btn btn-xs btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash fa-xs"></i></button>`; return [sN, fN, formatCurrency(rec.Amount), formatDate(rec.DueDate), st, acts]; }, 6); /* Colspan reduced */ } else { lB.innerHTML = `<tr><td colspan="6" class="text-danger p-4">Failed loading records.</td></tr>`; } }
        async function loadPrincipalSalaryData() { const pLB = document.getElementById('principalSalaryPaymentList'); pLB.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const sB = document.getElementById('principalStaffSalarySummary'); sB.innerHTML = '<tr><td colspan="4" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'StaffSalaryPayments' }); if (r && r.success) { const pays = (r.data || []).sort((a, b) => new Date(b.PaymentDate) - new Date(a.PaymentDate)); const sM = principalAllStaff.reduce((m, s) => (m[s.StaffID] = s.Name, m), {}); renderTable(pLB, pays, [], (p) => [sM[p.StaffID] || 'N/A', formatDate(p.PaymentDate), formatCurrency(p.Amount), p.MonthYear || 'N/A', p.Notes || ''], 5); /* Colspan reduced */ } else { pLB.innerHTML = `<tr><td colspan="5" class="text-danger p-4">Failed loading history.</td></tr>`; } if (principalAllStaff.length > 0) { renderTable(sB, principalAllStaff, [], (s) => [s.Name || 'N/A', formatCurrency(s.SalaryAmount), formatCurrency(s.TotalPaid), formatCurrency(s.TotalDues)], 4); } else { sB.innerHTML = '<tr><td colspan="4" class="text-muted p-4">No staff found.</td></tr>'; } }
        async function loadPrincipalExpenses() { const lB = document.getElementById('principalExpenseList'); lB.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Expenses' }); if (r && r.success) { const exps = (r.data || []).sort((a, b) => new Date(b.Date) - new Date(a.Date)); renderTable(lB, exps, [], (exp) => { const acts = `<button class="btn btn-sm btn-outline-primary me-1" title="Edit (Not Impl.)"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" title="Delete (Not Impl.)"><i class="fas fa-trash"></i></button>`; return [formatDate(exp.Date), exp.Category || 'N/A', exp.Description || 'N/A', formatCurrency(exp.Amount), acts]; }, 5); /* Colspan reduced */ } else { lB.innerHTML = `<tr><td colspan="5" class="text-danger p-4">Failed loading expenses.</td></tr>`; } }
        async function loadPrincipalAttendanceData() { const lB = document.getElementById('principalAttendanceList'); lB.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const sCId = document.getElementById('principalAttendanceClassSelect').value; const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Attendance' }); if (r && r.success) { let recs = r.data || []; if (sCId) recs = recs.filter(rec => rec.ClassID === sCId); recs.sort((a, b) => new Date(b.Date) - new Date(a.Date)); const cM = principalAllClasses.reduce((m, c) => (m[c.ClassID] = `${c.ClassName} ${c.Section || ''}`, m), {}); renderTable(lB, recs, [], (att) => { const p = (att.PresentStudentIDs || '').split(',').filter(id => id).length; const a = (att.AbsentStudentIDs || '').split(',').filter(id => id).length; const cN = cM[att.ClassID] || att.ClassID?.substring(0,6)+'...'; const dB = `<button class="btn btn-xs btn-outline-info view-attendance-details" data-date="${att.Date}" data-class-id="${att.ClassID}" data-present-ids="${att.PresentStudentIDs || ''}" data-absent-ids="${att.AbsentStudentIDs || ''}" title="View Details"><i class="fas fa-list fa-xs"></i></button>`; return [formatDate(att.Date), cN, p, a, dB]; }, 5); renderPrincipalClassAttendanceChart(recs, sCId); } else { lB.innerHTML = `<tr><td colspan="5" class="text-danger p-4">Failed loading attendance.</td></tr>`; destroyChart('principalClassAttendanceChart'); } }
        function showAttendanceDetailsModal(e) { const b = e.target.closest('.view-attendance-details'); if (!b) return; const dt = b.dataset.date, cId = b.dataset.classId, pIds = b.dataset.presentIds ? b.dataset.presentIds.split(',').filter(Boolean) : [], aIds = b.dataset.absentIds ? b.dataset.absentIds.split(',').filter(Boolean) : []; const cN = principalAllClasses.find(c => c.ClassID === cId)?.ClassName || cId; document.getElementById('modalAttendanceDate').textContent = formatDate(dt); document.getElementById('modalAttendanceClass').textContent = cN; document.getElementById('modalPresentCount').textContent = pIds.length; document.getElementById('modalAbsentCount').textContent = aIds.length; const pLU = document.getElementById('modalPresentList'), aLU = document.getElementById('modalAbsentList'); const sSrc = principalAllStudents; pLU.innerHTML = pIds.map(id => { const s = sSrc.find(st => st.StudentID === id); return `<li class="list-group-item border-0 px-0 text-success"><i class="fas fa-check-circle me-2"></i>${s ? `${s.RollNumber} - ${s.Name}` : `ID: ${id.substring(0, 6)}...`}</li>`; }).join('') || '<li class="list-group-item border-0 px-0 text-muted">None</li>'; aLU.innerHTML = aIds.map(id => { const s = sSrc.find(st => st.StudentID === id); return `<li class="list-group-item border-0 px-0 text-danger"><i class="fas fa-times-circle me-2"></i>${s ? `${s.RollNumber} - ${s.Name}` : `ID: ${id.substring(0, 6)}...`}</li>`; }).join('') || '<li class="list-group-item border-0 px-0 text-muted">None</li>'; bootstrap.Modal.getOrCreateInstance(document.getElementById('viewAttendanceDetailsModal')).show(); }
        function renderTable(tbody, data, headers, rowRenderer, colspan) { if (!tbody) return; tbody.innerHTML = ''; if (!data || data.length === 0) { tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted p-4">No data available.</td></tr>`; return; } data.forEach((item, index) => { const rD = rowRenderer(item); const tr = document.createElement('tr'); tr.classList.add('animate__animated', 'animate__fadeIn'); tr.style.animationDelay = `${index * 0.05}s`; rD.forEach(cD => { const td = document.createElement('td'); td.innerHTML = cD; tr.appendChild(td); }); tbody.appendChild(tr); }); }

        // --- Dropdown Population ---
        async function loadPrincipalClassesForDropdowns(selectIds = ['studentClass', 'principalAttendanceClassSelect', 'studentClassFilter']) { if (principalAllClasses.length === 0) { const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Classes' }); principalAllClasses = r?.success ? (r.data || []) : []; } populateClassSelects(principalAllClasses, selectIds); }
        function populateClassSelects(classes, selectIds) { let oH = '<option value="" selected disabled>-- Select --</option>'; let fOH = '<option value="">All Classes</option>'; if (classes.length > 0) { classes.sort((a, b) => (a.ClassName + (a.Section || '')).localeCompare(b.ClassName + (b.Section || ''))); classes.forEach(c => { const n = `${c.ClassName} ${c.Section || ''}`; oH += `<option value="${c.ClassID}">${n}</option>`; fOH += `<option value="${c.ClassID}">${n}</option>`; }); } else { oH = '<option disabled>No classes</option>'; fOH = '<option value="">No classes</option>'; } selectIds.forEach(id => { const s = document.getElementById(id); if (s) s.innerHTML = (id === 'principalAttendanceClassSelect' || id === 'studentClassFilter' ? fOH : oH); }); }
        async function loadPrincipalStudentsForDropdowns(selectIds = ['feeStudentSelect']) { if (principalAllStudents.length === 0) { const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Students' }); principalAllStudents = r?.success ? (r.data || []) : []; } populateStudentSelects(principalAllStudents, selectIds); }
        function populateStudentSelects(students, selectIds) { let oH = '<option value="" selected disabled>-- Select --</option>'; if (students.length > 0) { students.sort((a,b) => (a.Name || '').localeCompare(b.Name || '')); students.forEach(s => { oH += `<option value="${s.StudentID}">${s.RollNumber || 'N/R'} - ${s.Name || 'N/A'}</option>`; }); } else { oH = '<option disabled>No students</option>'; } selectIds.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = oH; }); }
        async function loadPrincipalStaffForDropdowns(selectIds = ['salaryStaffSelect']) { if (principalAllStaff.length === 0) { const r = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Staffs' }); principalAllStaff = r?.success ? (r.data || []) : []; } populateStaffSelects(principalAllStaff.filter(s => s.IsActive === true || String(s.IsActive).toUpperCase() === 'TRUE'), selectIds); }
        function populateStaffSelects(staffList, selectIds) { let oH = '<option value="" selected disabled>-- Select --</option>'; if (staffList.length > 0) { staffList.sort((a,b) => (a.Name || '').localeCompare(b.Name || '')); staffList.forEach(s => { oH += `<option value="${s.StaffID}">${s.Name || 'N/A'} (ID: ${s.StaffID?.substring(0,6)}...)</option>`; }); } else { oH = '<option disabled>No active staff</option>'; } selectIds.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = oH; }); }

        // --- Teacher Data Loading ---
        function loadTeacherDashboard() { loadTeacherDashboardOverview(); populateTeacherClassSelects(); const aDI = document.getElementById('attendanceDate'); if (aDI) aDI.valueAsDate = new Date(); }
        async function loadTeacherDashboardOverview() { document.getElementById('teacherNameWelcome').textContent = teacherName || 'Teacher'; document.getElementById('teacherAssignedClassesList').innerHTML = '<li class="list-group-item text-center p-3"><div class="spinner-border spinner-border-sm"></div></li>'; document.getElementById('teacherTotalStudentsCount').textContent = '...'; populateTeacherClassSelects(); if (teacherAssignedClasses.length > 0) { document.getElementById('teacherAssignedClassesList').innerHTML = teacherAssignedClasses.map(c => `<li class="list-group-item">${c.className} ${c.section || ''}</li>`).join(''); } else { document.getElementById('teacherAssignedClassesList').innerHTML = '<li class="list-group-item text-muted">No classes.</li>'; } const r = await callBackendAPI('getTeacherDashboardData', { spreadsheetId: teacherSpreadsheetId, staffId: teacherStaffId }); if (r && r.success) { let tS = 0; if (r.students) Object.values(r.students).forEach(a => tS += a.length); document.getElementById('teacherTotalStudentsCount').textContent = tS; checkTeacherTodayAttendanceStatus(r.attendanceSummary); renderTeacherOverviewChart(r.attendanceSummary); } }
        function checkTeacherTodayAttendanceStatus(summary) { const today = new Date().toLocaleDateString('en-CA'); let taken = false; if (summary && Array.isArray(summary)) { taken = summary.some(rec => { try { return new Date(rec.Date).toLocaleDateString('en-CA') === today; } catch(e){ return false; } }); } const sB = document.getElementById('teacherTodayAttendanceStatus'); sB.textContent = taken ? 'Taken Today' : 'Not Taken Yet'; sB.className = `badge bg-${taken ? 'success' : 'warning text-dark'}`; }
        function loadTeacherTabData(tId) { console.log("Loading teacher tab:", tId); switch (tId) { case 'teacher-dashboard-overview': loadTeacherDashboardOverview(); break; case 'teacher-take-attendance': document.getElementById('takeAttendanceForm')?.reset(); document.getElementById('attendanceStudentListContainer').style.display = 'none'; document.getElementById('attendanceStudentChecklist').innerHTML = ''; populateTeacherClassSelects(); const aDI = document.getElementById('attendanceDate'); if (aDI) aDI.valueAsDate = new Date(); break; case 'teacher-view-attendance': loadTeacherAttendanceRecords(); populateTeacherClassSelects(); break; case 'teacher-view-students': document.getElementById('teacherStudentList').innerHTML = '<tr><td colspan="6" class="text-center p-5">Select a class.</td></tr>'; populateTeacherClassSelects(); break; case 'teacher-profile': loadTeacherProfile(); break; } }
        function populateTeacherClassSelects() { const sI = [ { id: 'attendanceClassSelect', default: '-- Select --' }, { id: 'viewAttendanceClassSelect', default: 'All My Classes', includeAll: true }, { id: 'viewStudentClassSelect', default: '-- Select --' } ]; const oH = teacherAssignedClasses.map(c => `<option value="${c.classId}">${c.className} ${c.section || ''}</option>`).join(''); sI.forEach(i => { const s = document.getElementById(i.id); if(s) { let fO = i.includeAll ? `<option value="">${i.default}</option>` : `<option value="" selected disabled>${i.default}</option>`; s.innerHTML = fO + oH; } }); }
        async function loadTeacherAttendanceRecords() { const lB = document.getElementById('teacherAttendanceRecordList'); lB.innerHTML = '<tr><td colspan="5" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></td></tr>'; const sCId = document.getElementById('viewAttendanceClassSelect').value; const r = await callBackendAPI('getSchoolData', { spreadsheetId: teacherSpreadsheetId, sheetName: 'Attendance' }); if (r && r.success) { const all = r.data || []; const aCIds = teacherAssignedClasses.map(c => c.classId); let rel = all.filter(rec => aCIds.includes(rec.ClassID)); if (sCId) rel = rel.filter(rec => rec.ClassID === sCId); rel.sort((a, b) => new Date(b.Date) - new Date(a.Date)); const cM = teacherAssignedClasses.reduce((m, c) => (m[c.classId] = `${c.className} ${c.section || ''}`, m), {}); renderTable(lB, rel, [], (att) => { const p = (att.PresentStudentIDs || '').split(',').filter(id => id).length; const a = (att.AbsentStudentIDs || '').split(',').filter(id => id).length; const cN = cM[att.ClassID] || att.ClassID?.substring(0,6)+'...'; return [formatDate(att.Date), cN, p, a, p + a]; }, 5); renderTeacherClassAttendanceChart(rel, sCId); } else { lB.innerHTML = `<tr><td colspan="5" class="text-danger p-4">Failed loading attendance.</td></tr>`; destroyChart('teacherClassAttendanceChart'); } }
        async function loadTeacherStudentsByClass(cId) { const lB = document.getElementById('teacherStudentList'); lB.innerHTML = '<tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>'; if (!cId) { lB.innerHTML = '<tr><td colspan="6" class="p-5 text-muted text-center">Select a class.</td></tr>'; return; } const r = await callBackendAPI('getStudentsForClass', { spreadsheetId: teacherSpreadsheetId, classId: cId }); if (r && r.success) { renderTable(lB, r.data.sort((a,b) => (a.RollNumber || '').localeCompare(b.RollNumber || '')), [], (s) => { const photo = `<img src="${s.PhotoURL || 'https://via.placeholder.com/40?text=S'}" alt="Photo" width="40" height="40" class="rounded-circle">`; const actions = `<button class="btn btn-sm btn-outline-primary view-student-profile-btn" data-student-id="${s.StudentID || ''}" title="View Profile"><i class="fas fa-eye"></i></button>`; return [s.RollNumber || 'N/A', s.Name || 'N/A', s.Mobile || 'N/A', s.FatherName || 'N/A', photo, actions]; }, 6); } else { lB.innerHTML = `<tr><td colspan="6" class="text-danger p-4 text-center">Failed loading students.</td></tr>`; } }
        async function loadTeacherProfile() { const r = await callBackendAPI('getTeacherDashboardData', { spreadsheetId: teacherSpreadsheetId, staffId: teacherStaffId }); if (r && r.success && r.profile) { renderTeacherProfile(r.profile); } else { /* Handled */ } }
        function renderTeacherProfile(p) { document.getElementById('teacherProfilePhoto').src = p.PhotoURL || 'https://via.placeholder.com/150?text=T'; document.getElementById('teacherProfileName').textContent = p.Name || 'N/A'; document.getElementById('teacherProfileStaffID').textContent = p.StaffID?.substring(0, 8)+'...' || 'N/A'; document.getElementById('teacherProfileMobile').textContent = p.Mobile || 'N/A'; document.getElementById('teacherProfileGmail').textContent = p.Gmail || 'N/A'; document.getElementById('teacherProfileJoiningDate').textContent = formatDate(p.JoiningDate); document.getElementById('teacherProfileSalary').textContent = parseFloat(p.SalaryAmount || 0).toFixed(2); const isA = p.IsActive === true || String(p.IsActive).toUpperCase() === 'TRUE'; const sB = document.getElementById('teacherProfileStatus'); sB.textContent = isA ? 'Active' : 'Inactive'; sB.className = `badge bg-${isA ? 'success' : 'secondary'} fs-6`; }

        // --- Profile Modals ---
        async function showStudentProfile(studentId) {
            const modalElement = document.getElementById('studentProfileModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            // Reset fields
            modalElement.querySelectorAll('[id^="profileStudent"]').forEach(el => el.textContent = '...');
            document.getElementById('profileStudentPhoto').src = 'https://via.placeholder.com/120?text=S';
            document.getElementById('profileStudentFeeRecords').innerHTML = '<p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';
            document.getElementById('profileStudentAttendanceRecords').innerHTML = '<p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';

            const studentData = principalAllStudents.find(s => s.StudentID === studentId);
            if (!studentData) { showAlert('Student data not found locally.', 'warning'); return; }

            // Populate basic info immediately
            document.getElementById('profileStudentPhoto').src = studentData.PhotoURL || 'https://via.placeholder.com/120?text=S';
            document.getElementById('profileStudentName').textContent = studentData.Name || 'N/A';
            const studentClass = principalAllClasses.find(c => c.ClassID === studentData.Class);
            document.getElementById('profileStudentClass').textContent = studentClass ? `${studentClass.ClassName} ${studentClass.Section || ''}` : 'N/A';
            document.getElementById('profileStudentRoll').textContent = studentData.RollNumber || 'N/A';
            document.getElementById('profileStudentID').textContent = studentData.StudentID || 'N/A';
            document.getElementById('profileStudentGender').textContent = studentData.Gender || 'N/A';
            document.getElementById('profileStudentMobile').textContent = studentData.Mobile || 'N/A';
            document.getElementById('profileStudentGmail').textContent = studentData.Gmail || 'N/A';
            document.getElementById('profileStudentAddress').textContent = studentData.Address || 'N/A';
            document.getElementById('profileStudentAadhar').textContent = studentData.Aadhar || 'N/A';
            document.getElementById('profileStudentRegDate').textContent = formatDate(studentData.RegistrationDate);
            document.getElementById('profileStudentFather').textContent = studentData.FatherName || 'N/A';
            document.getElementById('profileStudentMother').textContent = studentData.MotherName || 'N/A';

            modal.show();

            // Fetch related data (Fees and Attendance)
            try {
                const [feeResult, attendanceResult] = await Promise.all([
                    callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'StudentsFees' }),
                    callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'Attendance' })
                ]);

                // Render Fees
                const feeRecordsDiv = document.getElementById('profileStudentFeeRecords');
                if (feeResult && feeResult.success) {
                    const studentFees = (feeResult.data || []).filter(f => f.StudentID === studentId).sort((a, b) => new Date(b.DueDate || 0) - new Date(a.DueDate || 0));
                     const feeTypeMap = principalAllFeeTypes.reduce((map, f) => (map[f.FeeTypeID] = f.FeeTypeName, map), {});
                    if (studentFees.length > 0) {
                        feeRecordsDiv.innerHTML = '<ul class="list-group list-group-flush">' + studentFees.map(fee => {
                             let badge = fee.Status === 'Paid' ? 'success' : fee.Status === 'Partial' ? 'warning' : fee.Status === 'Due' ? 'danger' : 'secondary';
                            return `<li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                <div>${feeTypeMap[fee.FeeTypeID] || 'Unknown Fee'} (${formatCurrency(fee.Amount)})<br><small class="text-muted">Due: ${formatDate(fee.DueDate)} | Paid: ${formatDate(fee.PaidDate)}</small></div>
                                <span class="badge bg-${badge}">${fee.Status}</span></li>`;
                        }).join('') + '</ul>';
                    } else { feeRecordsDiv.innerHTML = '<p class="text-muted text-center p-3">No fee records found.</p>'; }
                } else { feeRecordsDiv.innerHTML = '<p class="text-danger text-center p-3">Could not load fee records.</p>'; }

                // Render Attendance
                const attendanceRecordsDiv = document.getElementById('profileStudentAttendanceRecords');
                if (attendanceResult && attendanceResult.success) {
                     const studentAttendance = (attendanceResult.data || []).filter(a => (a.PresentStudentIDs?.includes(studentId) || a.AbsentStudentIDs?.includes(studentId))).sort((a, b) => new Date(b.Date || 0) - new Date(a.Date || 0));
                     const classMap = principalAllClasses.reduce((map, c) => (map[c.ClassID] = `${c.ClassName} ${c.Section || ''}`, map), {});
                    if (studentAttendance.length > 0) {
                         attendanceRecordsDiv.innerHTML = '<ul class="list-group list-group-flush">' + studentAttendance.map(att => {
                             const isPresent = att.PresentStudentIDs?.includes(studentId);
                             const statusText = isPresent ? 'Present' : 'Absent';
                             const statusClass = isPresent ? 'text-success' : 'text-danger';
                             const icon = isPresent ? 'fa-check-circle' : 'fa-times-circle';
                             const className = classMap[att.ClassID] || 'Unknown';
                              return `<li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                 <span>${formatDate(att.Date)} (${className})</span>
                                 <span class="${statusClass} fw-medium"><i class="fas ${icon} me-1"></i>${statusText}</span></li>`;
                         }).join('') + '</ul>';
                    } else { attendanceRecordsDiv.innerHTML = '<p class="text-muted text-center p-3">No attendance records found.</p>'; }
                } else { attendanceRecordsDiv.innerHTML = '<p class="text-danger text-center p-3">Could not load attendance records.</p>'; }

            } catch(error) {
                console.error("Error fetching profile details:", error);
                 document.getElementById('profileStudentFeeRecords').innerHTML = '<p class="text-danger text-center p-3">Error loading details.</p>';
                 document.getElementById('profileStudentAttendanceRecords').innerHTML = '<p class="text-danger text-center p-3">Error loading details.</p>';
            }
        }

        async function showStaffProfile(staffId) {
            const modalElement = document.getElementById('staffProfileModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
             // Reset fields
            modalElement.querySelectorAll('[id^="profileStaff"]').forEach(el => el.textContent = '...');
            document.getElementById('profileStaffPhoto').src = 'https://via.placeholder.com/120?text=T';
            document.getElementById('profileStaffSalaryRecords').innerHTML = '<p class="text-center p-3"><span class="spinner-border spinner-border-sm"></span> Loading...</p>';

            const staffData = principalAllStaff.find(s => s.StaffID === staffId);
            if (!staffData) { showAlert('Staff data not found locally.', 'warning'); return; }

             // Populate basic info
            document.getElementById('profileStaffPhoto').src = staffData.PhotoURL || 'https://via.placeholder.com/120?text=T';
            document.getElementById('profileStaffName').textContent = staffData.Name || 'N/A';
            document.getElementById('profileStaffID').textContent = staffData.StaffID?.substring(0, 8)+'...' || 'N/A';
            const isActive = staffData.IsActive === true || String(staffData.IsActive).toUpperCase() === 'TRUE';
            const statusBadge = document.getElementById('profileStaffStatus'); statusBadge.textContent = isActive ? 'Active' : 'Inactive'; statusBadge.className = `badge bg-${isActive ? 'success' : 'secondary'}`;
            document.getElementById('profileStaffMobile').textContent = staffData.Mobile || 'N/A';
            document.getElementById('profileStaffGmail').textContent = staffData.Gmail || 'N/A';
            document.getElementById('profileStaffJoiningDate').textContent = formatDate(staffData.JoiningDate);
            document.getElementById('profileStaffDesignatedSalary').textContent = formatCurrency(staffData.SalaryAmount);
            document.getElementById('profileStaffTotalPaid').textContent = formatCurrency(staffData.TotalPaid);
            document.getElementById('profileStaffTotalDues').textContent = formatCurrency(staffData.TotalDues);

            modal.show();

             // Fetch related data (Salary Payments)
             try {
                 const paymentResult = await callBackendAPI('getSchoolData', { spreadsheetId: principalSpreadsheetId, sheetName: 'StaffSalaryPayments' });
                 const paymentRecordsDiv = document.getElementById('profileStaffSalaryRecords');
                 if (paymentResult && paymentResult.success) {
                     const staffPayments = (paymentResult.data || []).filter(p => p.StaffID === staffId).sort((a, b) => new Date(b.PaymentDate || 0) - new Date(a.PaymentDate || 0));
                     if (staffPayments.length > 0) {
                         paymentRecordsDiv.innerHTML = '<ul class="list-group list-group-flush">' + staffPayments.map(pay => {
                             return `<li class="list-group-item d-flex justify-content-between align-items-center ps-0">
                                <span>${formatDate(pay.PaymentDate)} (${pay.MonthYear || 'N/A'})</span>
                                <span class="fw-medium">${formatCurrency(pay.Amount)}</span></li>`;
                         }).join('') + '</ul>';
                     } else { paymentRecordsDiv.innerHTML = '<p class="text-muted text-center p-3">No salary payments found.</p>'; }
                 } else { paymentRecordsDiv.innerHTML = '<p class="text-danger text-center p-3">Could not load payment records.</p>'; }
             } catch (error) {
                 console.error("Error fetching staff payment details:", error);
                 document.getElementById('profileStaffSalaryRecords').innerHTML = '<p class="text-danger text-center p-3">Error loading details.</p>';
             }
        }

        // --- Chart Rendering & Management ---
        function destroyChart(chartId) { if (chartInstances[chartId]) { chartInstances[chartId].destroy(); delete chartInstances[chartId]; } }
        function destroyAllCharts() { Object.keys(chartInstances).forEach(destroyChart); }
        function renderChart(chartId, type, data, options) { const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) { console.error("Canvas context not found:", chartId); return; } destroyChart(chartId); try { chartInstances[chartId] = new Chart(ctx, { type, data, options }); } catch (e) { console.error("Chart render error:", chartId, e); } }
        function renderPrincipalOverviewCharts(attendanceData, financialData) { const attLbl = ['D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7']; const attPr = [90, 85, 92, 88, 95, 91, 89]; renderChart('principalAttendanceChart', 'line', { labels: attLbl, datasets: [{ label: '% Present', data: attPr, borderColor: 'rgb(75, 192, 192)', tension: 0.3, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.1)' }] }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }); const finLbl = ['Income', 'Expenses', 'Salary']; const finV = [ parseFloat(financialData?.totalIncome || 0), parseFloat(financialData?.totalExpenses || 0), parseFloat(financialData?.totalSalaryPaid || 0) ]; renderChart('principalFinancialChart', 'doughnut', { labels: finLbl, datasets: [{ label: 'Amount (Rs )', data: finV, backgroundColor: ['rgba(75, 192, 192, 0.8)','rgba(255, 99, 132, 0.8)','rgba(255, 159, 64, 0.8)'], hoverOffset: 8 }] }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }); }
        function renderPrincipalClassAttendanceChart(records, classId) { if (!records || records.length === 0) { destroyChart('principalClassAttendanceChart'); return; } const max = 15; const recs = records.slice(0, max).reverse(); const labels = recs.map(r => formatDate(r.Date)); const present = recs.map(r => (r.PresentStudentIDs || '').split(',').filter(id=>id).length); const absent = recs.map(r => (r.AbsentStudentIDs || '').split(',').filter(id=>id).length); const cls = principalAllClasses.find(c=>c.ClassID === classId); const title = classId ? `Attendance: ${cls?.ClassName || 'Selected'}` : 'Overall Attendance (Last 15)'; renderChart('principalClassAttendanceChart', 'bar', { labels: labels, datasets: [ { label: 'Present', data: present, backgroundColor: 'rgba(75, 192, 192, 0.7)' }, { label: 'Absent', data: absent, backgroundColor: 'rgba(255, 99, 132, 0.7)' } ] }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { title: { display: true, text: title, font: { size: 14 } }, legend: { display: true, position: 'bottom' } } }); }
        function renderTeacherOverviewChart(summary) { if (!summary || summary.length === 0) { destroyChart('teacherAttendanceSummaryChart'); return; } const max = 7; const recs = summary.sort((a, b) => new Date(b.Date) - new Date(a.Date)).slice(0, max).reverse(); const labels = recs.map(r => formatDate(r.Date)); const present = recs.map(r => (r.PresentStudentIDs || '').split(',').filter(id=>id).length); const absent = recs.map(r => (r.AbsentStudentIDs || '').split(',').filter(id=>id).length); renderChart('teacherAttendanceSummaryChart', 'line', { labels: labels, datasets: [ { label: 'Present', data: present, borderColor: 'rgb(54, 162, 235)', tension: 0.3, fill: true, backgroundColor: 'rgba(54, 162, 235, 0.1)' }, { label: 'Absent', data: absent, borderColor: 'rgb(255, 99, 132)', tension: 0.3, fill: false } ] }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { title: { display: false }, legend: { display: true, position: 'bottom' } } }); }
        function renderTeacherClassAttendanceChart(records, classId) { if (!records || records.length === 0) { destroyChart('teacherClassAttendanceChart'); return; } const max = 10; const recs = records.slice(0, max).reverse(); const labels = recs.map(r => formatDate(r.Date)); const present = recs.map(r => (r.PresentStudentIDs || '').split(',').filter(id=>id).length); const absent = recs.map(r => (r.AbsentStudentIDs || '').split(',').filter(id=>id).length); let title = 'Attendance Trend (Last 10)'; if (classId) { const cls = teacherAssignedClasses.find(c => c.classId === classId); if (cls) title = `Attendance: ${cls.className} ${cls.section || ''}`; } else if (teacherAssignedClasses.length === 1) { const cls = teacherAssignedClasses[0]; if (cls) title = `Attendance: ${cls.className} ${cls.section || ''}`; } renderChart('teacherClassAttendanceChart', 'bar', { labels: labels, datasets: [ { label: 'Present', data: present, backgroundColor: 'rgba(75, 192, 192, 0.7)' }, { label: 'Absent', data: absent, backgroundColor: 'rgba(255, 99, 132, 0.7)' } ] }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { title: { display: true, text: title, font: { size: 14 } }, legend: { display: true, position: 'bottom' } } }); }

    </script>

</body>
</html>
